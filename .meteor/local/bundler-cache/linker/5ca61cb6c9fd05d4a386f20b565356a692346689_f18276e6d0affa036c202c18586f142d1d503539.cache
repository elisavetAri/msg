[{"type":"js","data":"//////////////////////////////////////////////////////////////////////////\n//                                                                      //\n// This is a generated file. You can view the original                  //\n// source in your browser if your browser supports source maps.         //\n// Source maps are supported by all recent versions of Chrome, Safari,  //\n// and Firefox, and by Internet Explorer 11.                            //\n//                                                                      //\n//////////////////////////////////////////////////////////////////////////\n\n\n(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar DDPCommon = Package['ddp-common'].DDPCommon;\nvar check = Package.check.check;\nvar Match = Package.check.Match;\nvar Tracker = Package.tracker.Tracker;\nvar Deps = Package.tracker.Deps;\nvar meteorInstall = Package.modules.meteorInstall;\nvar meteorBabelHelpers = Package['babel-runtime'].meteorBabelHelpers;\nvar Promise = Package.promise.Promise;\nvar Symbol = Package['ecmascript-runtime-client'].Symbol;\nvar Map = Package['ecmascript-runtime-client'].Map;\nvar Set = Package['ecmascript-runtime-client'].Set;\n\n/* Package-scope variables */\nvar EV, Streamer;\n\nvar require = meteorInstall({\"node_modules\":{\"meteor\":{\"rocketchat:streamer\":{\"lib\":{\"ev.js\":function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/rocketchat_streamer/lib/ev.js                                                                              //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\n/* globals EV:true */\n\n/* exported EV */\nEV =\n/*#__PURE__*/\nfunction () {\n  function EV() {\n    this.handlers = {};\n  }\n\n  var _proto = EV.prototype;\n\n  _proto.emit = function () {\n    function emit(event) {\n      var _this = this;\n\n      for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n        args[_key - 1] = arguments[_key];\n      }\n\n      return this.handlers[event] && this.handlers[event].forEach(function (handler) {\n        return handler.apply(_this, args);\n      });\n    }\n\n    return emit;\n  }();\n\n  _proto.emitWithScope = function () {\n    function emitWithScope(event, scope) {\n      for (var _len2 = arguments.length, args = new Array(_len2 > 2 ? _len2 - 2 : 0), _key2 = 2; _key2 < _len2; _key2++) {\n        args[_key2 - 2] = arguments[_key2];\n      }\n\n      return this.handlers[event] && this.handlers[event].forEach(function (handler) {\n        return handler.apply(scope, args);\n      });\n    }\n\n    return emitWithScope;\n  }();\n\n  _proto.listenerCount = function () {\n    function listenerCount(event) {\n      return this.handlers[event] && this.handlers[event].length || 0;\n    }\n\n    return listenerCount;\n  }();\n\n  _proto.on = function () {\n    function on(event, callback) {\n      if (!this.handlers[event]) {\n        this.handlers[event] = [];\n      }\n\n      this.handlers[event].push(callback);\n    }\n\n    return on;\n  }();\n\n  _proto.once = function () {\n    function once(event, callback) {\n      var self = this;\n      this.on(event, function () {\n        function onetimeCallback() {\n          self.removeListener(event, onetimeCallback);\n          callback.apply(this, arguments);\n        }\n\n        return onetimeCallback;\n      }());\n    }\n\n    return once;\n  }();\n\n  _proto.removeListener = function () {\n    function removeListener(event, callback) {\n      if (!this.handlers[event]) {\n        return;\n      }\n\n      var index = this.handlers[event].indexOf(callback);\n\n      if (index > -1) {\n        this.handlers[event].splice(index, 1);\n      }\n    }\n\n    return removeListener;\n  }();\n\n  _proto.removeAllListeners = function () {\n    function removeAllListeners(event) {\n      this.handlers[event] = undefined;\n    }\n\n    return removeAllListeners;\n  }();\n\n  return EV;\n}();\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}},\"client\":{\"client.js\":function(require){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/rocketchat_streamer/client/client.js                                                                       //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\n/* globals DDPCommon, EV */\n\n/* eslint-disable new-cap */\nvar NonEmptyString = Match.Where(function (x) {\n  check(x, String);\n  return x.length > 0;\n});\n\nvar StreamerCentral =\n/*#__PURE__*/\nfunction (_EV) {\n  (0, _inheritsLoose2.default)(StreamerCentral, _EV);\n\n  function StreamerCentral() {\n    var _this;\n\n    _this = _EV.call(this) || this;\n    _this.instances = {};\n    _this.ddpConnections = {}; // since each Streamer instance can provide its own ddp connection, store them by streamer name\n\n    return _this;\n  }\n\n  var _proto = StreamerCentral.prototype;\n\n  _proto.setupDdpConnection = function () {\n    function setupDdpConnection(name, ddpConnection) {\n      var _this2 = this;\n\n      // make sure we only setup event listeners for each ddp connection once\n      if (ddpConnection.hasMeteorStreamerEventListeners) {\n        return;\n      }\n\n      ddpConnection._stream.on('message', function (raw_msg) {\n        var msg = DDPCommon.parseDDP(raw_msg);\n\n        if (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n          msg.fields.args.unshift(msg.fields.eventName);\n          msg.fields.args.unshift(msg.collection);\n\n          _this2.emit.apply(_this2, msg.fields.args);\n        }\n      }); // store ddp connection\n\n\n      this.storeDdpConnection(name, ddpConnection);\n    }\n\n    return setupDdpConnection;\n  }();\n\n  _proto.storeDdpConnection = function () {\n    function storeDdpConnection(name, ddpConnection) {\n      // mark the connection as setup for Streamer, and store it\n      ddpConnection.hasMeteorStreamerEventListeners = true;\n      this.ddpConnections[name] = ddpConnection;\n    }\n\n    return storeDdpConnection;\n  }();\n\n  return StreamerCentral;\n}(EV);\n\nMeteor.StreamerCentral = new StreamerCentral();\n\nMeteor.Streamer =\n/*#__PURE__*/\nfunction (_EV2) {\n  (0, _inheritsLoose2.default)(Streamer, _EV2);\n\n  function Streamer(name) {\n    var _this3;\n\n    var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n        _ref$useCollection = _ref.useCollection,\n        useCollection = _ref$useCollection === void 0 ? false : _ref$useCollection,\n        _ref$ddpConnection = _ref.ddpConnection,\n        ddpConnection = _ref$ddpConnection === void 0 ? Meteor.connection : _ref$ddpConnection;\n\n    if (Meteor.StreamerCentral.instances[name]) {\n      console.warn('Streamer instance already exists:', name);\n      return Meteor.StreamerCentral.instances[name] || (0, _assertThisInitialized2.default)(_this3);\n    }\n\n    Meteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n    _this3 = _EV2.call(this) || this;\n    _this3.ddpConnection = ddpConnection || Meteor.connection;\n    Meteor.StreamerCentral.instances[name] = (0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this3));\n    _this3.name = name;\n    _this3.useCollection = useCollection;\n    _this3.subscriptions = {};\n    Meteor.StreamerCentral.on(_this3.subscriptionName, function (eventName) {\n      if (_this3.subscriptions[eventName]) {\n        var _EV2$prototype$emit;\n\n        for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n          args[_key - 1] = arguments[_key];\n        }\n\n        _this3.subscriptions[eventName].lastMessage = args;\n\n        (_EV2$prototype$emit = _EV2.prototype.emit).call.apply(_EV2$prototype$emit, [(0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this3)), eventName].concat(args));\n      }\n    });\n\n    _this3.ddpConnection._stream.on('reset', function () {\n      _EV2.prototype.emit.call((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this3)), '__reconnect__');\n    });\n\n    return _this3;\n  }\n\n  var _proto2 = Streamer.prototype;\n\n  _proto2.stop = function () {\n    function stop(eventName) {\n      return this.subscriptions[eventName] && this.subscriptions[eventName].subscription && this.subscriptions[eventName].subscription.stop();\n    }\n\n    return stop;\n  }();\n\n  _proto2.stopAll = function () {\n    function stopAll() {\n      var _this4 = this;\n\n      Object.keys(this.subscriptions).forEach(function (eventName) {\n        return _this4.removeAllListeners(eventName);\n      });\n    }\n\n    return stopAll;\n  }();\n\n  _proto2.unsubscribe = function () {\n    function unsubscribe(eventName) {\n      delete this.subscriptions[eventName];\n\n      _EV2.prototype.removeAllListeners.call(this, eventName);\n    }\n\n    return unsubscribe;\n  }();\n\n  _proto2.subscribe = function () {\n    function subscribe(eventName, args) {\n      var _this5 = this;\n\n      if (this.subscriptions[eventName]) {\n        return;\n      }\n\n      var subscription = Tracker.nonreactive(function () {\n        return _this5.ddpConnection.subscribe(_this5.subscriptionName, eventName, {\n          useCollection: _this5.useCollection,\n          args: args\n        }, {\n          onStop: function () {\n            return _this5.unsubscribe(eventName);\n          }\n        });\n      });\n      this.subscriptions[eventName] = {\n        subscription: subscription\n      };\n    }\n\n    return subscribe;\n  }();\n\n  _proto2.onReconnect = function () {\n    function onReconnect(fn) {\n      if (typeof fn === 'function') {\n        _EV2.prototype.on.call(this, '__reconnect__', fn);\n      }\n    }\n\n    return onReconnect;\n  }();\n\n  _proto2.getLastMessageFromEvent = function () {\n    function getLastMessageFromEvent(eventName) {\n      var subscription = this.subscriptions[eventName];\n\n      if (subscription && subscription.lastMessage) {\n        return subscription.lastMessage;\n      }\n    }\n\n    return getLastMessageFromEvent;\n  }();\n\n  _proto2.removeAllListeners = function () {\n    function removeAllListeners(eventName) {\n      _EV2.prototype.removeAllListeners.call(this, eventName);\n\n      return this.stop(eventName);\n    }\n\n    return removeAllListeners;\n  }();\n\n  _proto2.removeListener = function () {\n    function removeListener(eventName) {\n      var _EV2$prototype$remove;\n\n      if (this.listenerCount(eventName) === 1) {\n        this.stop(eventName);\n      }\n\n      for (var _len2 = arguments.length, args = new Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n        args[_key2 - 1] = arguments[_key2];\n      }\n\n      (_EV2$prototype$remove = _EV2.prototype.removeListener).call.apply(_EV2$prototype$remove, [this, eventName].concat(args));\n    }\n\n    return removeListener;\n  }();\n\n  _proto2.on = function () {\n    function on(eventName) {\n      check(eventName, NonEmptyString);\n\n      for (var _len3 = arguments.length, args = new Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {\n        args[_key3 - 1] = arguments[_key3];\n      }\n\n      var callback = args.pop();\n      check(callback, Function);\n      this.subscribe(eventName, args);\n\n      _EV2.prototype.on.call(this, eventName, callback);\n    }\n\n    return on;\n  }();\n\n  _proto2.once = function () {\n    function once(eventName) {\n      var _this6 = this;\n\n      check(eventName, NonEmptyString);\n\n      for (var _len4 = arguments.length, args = new Array(_len4 > 1 ? _len4 - 1 : 0), _key4 = 1; _key4 < _len4; _key4++) {\n        args[_key4 - 1] = arguments[_key4];\n      }\n\n      var callback = args.pop();\n      check(callback, Function);\n      this.subscribe(eventName, args);\n\n      _EV2.prototype.once.call(this, eventName, function () {\n        callback.apply(void 0, arguments);\n\n        if (_this6.listenerCount(eventName) === 0) {\n          return _this6.stop(eventName);\n        }\n      });\n    }\n\n    return once;\n  }();\n\n  _proto2.emit = function () {\n    function emit() {\n      var _this$ddpConnection;\n\n      for (var _len5 = arguments.length, args = new Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {\n        args[_key5] = arguments[_key5];\n      }\n\n      (_this$ddpConnection = this.ddpConnection).call.apply(_this$ddpConnection, [this.subscriptionName].concat(args));\n    }\n\n    return emit;\n  }();\n\n  (0, _createClass2.default)(Streamer, [{\n    key: \"name\",\n    get: function () {\n      return this._name;\n    },\n    set: function (name) {\n      check(name, String);\n      this._name = name;\n    }\n  }, {\n    key: \"subscriptionName\",\n    get: function () {\n      return \"stream-\" + this.name;\n    }\n  }, {\n    key: \"useCollection\",\n    get: function () {\n      return this._useCollection;\n    },\n    set: function (useCollection) {\n      check(useCollection, Boolean);\n      this._useCollection = useCollection;\n    }\n  }]);\n  return Streamer;\n}(EV);\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}}}}}},{\n  \"extensions\": [\n    \".js\",\n    \".json\"\n  ]\n});\n\nrequire(\"/node_modules/meteor/rocketchat:streamer/lib/ev.js\");\nrequire(\"/node_modules/meteor/rocketchat:streamer/client/client.js\");\n\n/* Exports */\nPackage._define(\"rocketchat:streamer\", {\n  Streamer: Streamer\n});\n\n})();\n","servePath":"/packages/rocketchat_streamer.js","sourceMap":{"version":3,"sources":["packages/rocketchat:streamer/lib/ev.js","packages/rocketchat:streamer/client/client.js"],"names":["EV","handlers","emit","event","args","forEach","handler","apply","emitWithScope","scope","listenerCount","length","on","callback","push","once","self","onetimeCallback","removeListener","arguments","index","indexOf","splice","removeAllListeners","undefined","NonEmptyString","Match","Where","x","check","String","StreamerCentral","instances","ddpConnections","setupDdpConnection","name","ddpConnection","hasMeteorStreamerEventListeners","_stream","raw_msg","msg","DDPCommon","parseDDP","collection","fields","eventName","unshift","storeDdpConnection","Meteor","Streamer","useCollection","connection","console","warn","subscriptions","subscriptionName","lastMessage","call","stop","subscription","stopAll","Object","keys","unsubscribe","subscribe","Tracker","nonreactive","onStop","onReconnect","fn","getLastMessageFromEvent","pop","Function","_name","_useCollection","Boolean"],"mappings":"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","file":"/packages/rocketchat_streamer.js","sourcesContent":["/* globals EV:true */\n/* exported EV */\n\nEV = class EV {\n\tconstructor() {\n\t\tthis.handlers = {};\n\t}\n\n\temit(event, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(this, args));\n\t}\n\n\temitWithScope(event, scope, ...args) {\n\t\treturn this.handlers[event] && this.handlers[event].forEach(handler => handler.apply(scope, args));\n\t}\n\n\tlistenerCount(event) {\n\t\treturn (this.handlers[event] && this.handlers[event].length) || 0;\n\t}\n\n\ton(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\tthis.handlers[event] = [];\n\t\t}\n\t\tthis.handlers[event].push(callback);\n\t}\n\n\tonce(event, callback) {\n\t\tconst self = this;\n\t\tthis.on(event, function onetimeCallback() {\n\t\t\tself.removeListener(event, onetimeCallback);\n\t\t\tcallback.apply(this, arguments);\n\t\t});\n\t}\n\n\tremoveListener(event, callback) {\n\t\tif (!this.handlers[event]) {\n\t\t\treturn;\n\t\t}\n\t\tconst index = this.handlers[event].indexOf(callback);\n\t\tif (index > -1) {\n\t\t\tthis.handlers[event].splice(index, 1);\n\t\t}\n\t}\n\n\tremoveAllListeners(event) {\n\t\tthis.handlers[event] = undefined;\n\t}\n};\n","/* globals DDPCommon, EV */\n/* eslint-disable new-cap */\nconst NonEmptyString = Match.Where(function (x) {\n\tcheck(x, String);\n\treturn x.length > 0;\n});\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t\tthis.ddpConnections = {};\t\t// since each Streamer instance can provide its own ddp connection, store them by streamer name\n\t}\n\n\tsetupDdpConnection(name, ddpConnection) {\n\t\t// make sure we only setup event listeners for each ddp connection once\n\t\tif (ddpConnection.hasMeteorStreamerEventListeners) {\n\t\t\treturn;\n\t\t}\n\t\tddpConnection._stream.on('message', (raw_msg) => {\n\t\t\tconst msg = DDPCommon.parseDDP(raw_msg);\n\t\t\tif (msg && msg.msg === 'changed' && msg.collection && msg.fields && msg.fields.eventName && msg.fields.args) {\n\t\t\t\tmsg.fields.args.unshift(msg.fields.eventName);\n\t\t\t\tmsg.fields.args.unshift(msg.collection);\n\t\t\t\tthis.emit.apply(this, msg.fields.args);\n\t\t\t}\n\t\t});\n\t\t// store ddp connection\n\t\tthis.storeDdpConnection(name, ddpConnection);\n\n\t}\n\n\tstoreDdpConnection(name, ddpConnection) {\n\t\t// mark the connection as setup for Streamer, and store it\n\t\tddpConnection.hasMeteorStreamerEventListeners = true;\n\t\tthis.ddpConnections[name] = ddpConnection;\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, { useCollection = false, ddpConnection = Meteor.connection } = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\t\tMeteor.StreamerCentral.setupDdpConnection(name, ddpConnection);\n\n\t\tsuper();\n\n\t\tthis.ddpConnection = ddpConnection || Meteor.connection;\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.useCollection = useCollection;\n\t\tthis.subscriptions = {};\n\n\t\tMeteor.StreamerCentral.on(this.subscriptionName, (eventName, ...args) => {\n\t\t\tif (this.subscriptions[eventName]) {\n\t\t\t\tthis.subscriptions[eventName].lastMessage = args;\n\t\t\t\tsuper.emit.call(this, eventName, ...args);\n\t\t\t}\n\t\t});\n\n\t\tthis.ddpConnection._stream.on('reset', () => {\n\t\t\tsuper.emit.call(this, '__reconnect__');\n\t\t});\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget useCollection() {\n\t\treturn this._useCollection;\n\t}\n\n\tset useCollection(useCollection) {\n\t\tcheck(useCollection, Boolean);\n\t\tthis._useCollection = useCollection;\n\t}\n\n\tstop(eventName) {\n\t\treturn this.subscriptions[eventName] && this.subscriptions[eventName].subscription && this.subscriptions[eventName].subscription.stop();\n\t}\n\n\tstopAll() {\n\t\tObject.keys(this.subscriptions).forEach(eventName => this.removeAllListeners(eventName));\n\t}\n\n\tunsubscribe(eventName) {\n\t\tdelete this.subscriptions[eventName];\n\t\tsuper.removeAllListeners(eventName);\n\t}\n\n\tsubscribe(eventName, args) {\n\t\tif (this.subscriptions[eventName]) {\n\t\t\treturn;\n\t\t}\n\t\tconst subscription = Tracker.nonreactive(() => this.ddpConnection.subscribe(\n\t\t\tthis.subscriptionName,\n\t\t\teventName,\n\t\t\t{ useCollection: this.useCollection, args },\n\t\t\t{ onStop: () => this.unsubscribe(eventName) }\n\t\t));\n\t\tthis.subscriptions[eventName] = { subscription };\n\t}\n\n\tonReconnect(fn) {\n\t\tif (typeof fn === 'function') {\n\t\t\tsuper.on('__reconnect__', fn);\n\t\t}\n\t}\n\n\tgetLastMessageFromEvent(eventName) {\n\t\tconst subscription = this.subscriptions[eventName];\n\t\tif (subscription && subscription.lastMessage) {\n\t\t\treturn subscription.lastMessage;\n\t\t}\n\t}\n\n\tremoveAllListeners(eventName) {\n\t\tsuper.removeAllListeners(eventName);\n\t\treturn this.stop(eventName);\n\t}\n\n\tremoveListener(eventName, ...args) {\n\t\tif (this.listenerCount(eventName) === 1) {\n\t\t\tthis.stop(eventName);\n\t\t}\n\t\tsuper.removeListener(eventName, ...args);\n\t}\n\n\ton(eventName, ...args) {\n\t\tcheck(eventName, NonEmptyString);\n\n\t\tconst callback = args.pop();\n\t\tcheck(callback, Function);\n\n\t\tthis.subscribe(eventName, args);\n\t\tsuper.on(eventName, callback);\n\t}\n\n\tonce(eventName, ...args) {\n\t\tcheck(eventName, NonEmptyString);\n\n\t\tconst callback = args.pop();\n\t\tcheck(callback, Function);\n\n\t\tthis.subscribe(eventName, args);\n\n\t\tsuper.once(eventName, (...args) => {\n\t\t\tcallback(...args);\n\t\t\tif (this.listenerCount(eventName) === 0) {\n\t\t\t\treturn this.stop(eventName);\n\t\t\t}\n\t\t});\n\t}\n\n\temit(...args) {\n\t\tthis.ddpConnection.call(this.subscriptionName, ...args);\n\t}\n};\n"]}}]