{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Sandbox\\test\\packages\\rocketchat:streamer\\server\\server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","jsx",["flow",{}],["flow",{}],"objectRestSpread","objectRestSpread","dynamicImport","asyncGenerators","classProperties","classPrivateProperties"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.windows.x86_64"},"sourceFileName":"packages/rocketchat:streamer/server/server.js","filename":"C:\\Sandbox\\test\\packages\\rocketchat:streamer\\server\\server.js","passPerPreset":false,"envName":"development","cwd":"C:\\Sandbox\\test","root":"C:\\Sandbox\\test","plugins":[{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}}],"presets":[],"generatorOpts":{"filename":"C:\\Sandbox\\test\\packages\\rocketchat:streamer\\server\\server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/rocketchat:streamer/server/server.js"}},"code":"let DDPCommon;\nmodule.link(\"meteor/ddp-common\", {\n  DDPCommon(v) {\n    DDPCommon = v;\n  }\n\n}, 0);\n\nclass StreamerCentral extends EV {\n  constructor() {\n    super();\n    this.instances = {};\n  }\n\n}\n\nMeteor.StreamerCentral = new StreamerCentral();\n\nconst changedPayload = function (collection, id, fields) {\n  if (_.isEmpty(fields)) {\n    return;\n  }\n\n  return DDPCommon.stringifyDDP({\n    msg: 'changed',\n    collection,\n    id,\n    fields\n  });\n};\n\nconst send = function (self, msg) {\n  if (!self.socket) {\n    return;\n  }\n\n  self.socket.send(msg);\n};\n\nMeteor.Streamer = class Streamer extends EV {\n  constructor(name, {\n    retransmit = true,\n    retransmitToSelf = false\n  } = {}) {\n    if (Meteor.StreamerCentral.instances[name]) {\n      console.warn('Streamer instance already exists:', name);\n      return Meteor.StreamerCentral.instances[name];\n    }\n\n    super();\n    Meteor.StreamerCentral.instances[name] = this;\n    this.name = name;\n    this.retransmit = retransmit;\n    this.retransmitToSelf = retransmitToSelf;\n    this.subscriptions = [];\n    this.subscriptionsByEventName = {};\n    this.transformers = {};\n    this.iniPublication();\n    this.initMethod();\n    this._allowRead = {};\n    this._allowEmit = {};\n    this._allowWrite = {};\n    this.allowRead('none');\n    this.allowEmit('all');\n    this.allowWrite('none');\n  }\n\n  get name() {\n    return this._name;\n  }\n\n  set name(name) {\n    check(name, String);\n    this._name = name;\n  }\n\n  get subscriptionName() {\n    return `stream-${this.name}`;\n  }\n\n  get retransmit() {\n    return this._retransmit;\n  }\n\n  set retransmit(retransmit) {\n    check(retransmit, Boolean);\n    this._retransmit = retransmit;\n  }\n\n  get retransmitToSelf() {\n    return this._retransmitToSelf;\n  }\n\n  set retransmitToSelf(retransmitToSelf) {\n    check(retransmitToSelf, Boolean);\n    this._retransmitToSelf = retransmitToSelf;\n  }\n\n  allowRead(eventName, fn) {\n    if (fn === undefined) {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (typeof fn === 'function') {\n      return this._allowRead[eventName] = fn;\n    }\n\n    if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n      console.error(`allowRead shortcut '${fn}' is invalid`);\n    }\n\n    if (fn === 'all' || fn === true) {\n      return this._allowRead[eventName] = function () {\n        return true;\n      };\n    }\n\n    if (fn === 'none' || fn === false) {\n      return this._allowRead[eventName] = function () {\n        return false;\n      };\n    }\n\n    if (fn === 'logged') {\n      return this._allowRead[eventName] = function () {\n        return Boolean(this.userId);\n      };\n    }\n  }\n\n  allowEmit(eventName, fn) {\n    if (fn === undefined) {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (typeof fn === 'function') {\n      return this._allowEmit[eventName] = fn;\n    }\n\n    if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n      console.error(`allowRead shortcut '${fn}' is invalid`);\n    }\n\n    if (fn === 'all' || fn === true) {\n      return this._allowEmit[eventName] = function () {\n        return true;\n      };\n    }\n\n    if (fn === 'none' || fn === false) {\n      return this._allowEmit[eventName] = function () {\n        return false;\n      };\n    }\n\n    if (fn === 'logged') {\n      return this._allowEmit[eventName] = function () {\n        return Boolean(this.userId);\n      };\n    }\n  }\n\n  allowWrite(eventName, fn) {\n    if (fn === undefined) {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (typeof fn === 'function') {\n      return this._allowWrite[eventName] = fn;\n    }\n\n    if (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n      console.error(`allowWrite shortcut '${fn}' is invalid`);\n    }\n\n    if (fn === 'all' || fn === true) {\n      return this._allowWrite[eventName] = function () {\n        return true;\n      };\n    }\n\n    if (fn === 'none' || fn === false) {\n      return this._allowWrite[eventName] = function () {\n        return false;\n      };\n    }\n\n    if (fn === 'logged') {\n      return this._allowWrite[eventName] = function () {\n        return Boolean(this.userId);\n      };\n    }\n  }\n\n  isReadAllowed(scope, eventName, args) {\n    if (this._allowRead[eventName]) {\n      return this._allowRead[eventName].call(scope, eventName, ...args);\n    }\n\n    return this._allowRead['__all__'].call(scope, eventName, ...args);\n  }\n\n  isEmitAllowed(scope, eventName, ...args) {\n    if (this._allowEmit[eventName]) {\n      return this._allowEmit[eventName].call(scope, eventName, ...args);\n    }\n\n    return this._allowEmit['__all__'].call(scope, eventName, ...args);\n  }\n\n  isWriteAllowed(scope, eventName, args) {\n    if (this._allowWrite[eventName]) {\n      return this._allowWrite[eventName].call(scope, eventName, ...args);\n    }\n\n    return this._allowWrite['__all__'].call(scope, eventName, ...args);\n  }\n\n  addSubscription(subscription, eventName) {\n    this.subscriptions.push(subscription);\n\n    if (!this.subscriptionsByEventName[eventName]) {\n      this.subscriptionsByEventName[eventName] = [];\n    }\n\n    this.subscriptionsByEventName[eventName].push(subscription);\n  }\n\n  removeSubscription(subscription, eventName) {\n    const index = this.subscriptions.indexOf(subscription);\n\n    if (index > -1) {\n      this.subscriptions.splice(index, 1);\n    }\n\n    if (this.subscriptionsByEventName[eventName]) {\n      const index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n\n      if (index > -1) {\n        this.subscriptionsByEventName[eventName].splice(index, 1);\n      }\n    }\n  }\n\n  transform(eventName, fn) {\n    if (typeof eventName === 'function') {\n      fn = eventName;\n      eventName = '__all__';\n    }\n\n    if (!this.transformers[eventName]) {\n      this.transformers[eventName] = [];\n    }\n\n    this.transformers[eventName].push(fn);\n  }\n\n  applyTransformers(methodScope, eventName, args) {\n    if (this.transformers['__all__']) {\n      this.transformers['__all__'].forEach(transform => {\n        args = transform.call(methodScope, eventName, args);\n        methodScope.tranformed = true;\n\n        if (!Array.isArray(args)) {\n          args = [args];\n        }\n      });\n    }\n\n    if (this.transformers[eventName]) {\n      this.transformers[eventName].forEach(transform => {\n        args = transform.call(methodScope, ...args);\n        methodScope.tranformed = true;\n\n        if (!Array.isArray(args)) {\n          args = [args];\n        }\n      });\n    }\n\n    return args;\n  }\n\n  _publish(publication, eventName, options) {\n    check(eventName, String);\n    check(options, Match.OneOf(Boolean, {\n      useCollection: Boolean,\n      args: Array\n    }));\n    let useCollection,\n        args = [];\n\n    if (typeof options === 'boolean') {\n      useCollection = options;\n    } else {\n      if (options.useCollection) {\n        useCollection = options.useCollection;\n      }\n\n      if (options.args) {\n        args = options.args;\n      }\n    }\n\n    if (eventName.length === 0) {\n      publication.stop();\n      throw new Meteor.Error('invalid-event-name');\n    }\n\n    if (this.isReadAllowed(publication, eventName, args) !== true) {\n      publication.stop();\n      throw new Meteor.Error('not-allowed');\n    }\n\n    const subscription = {\n      subscription: publication,\n      eventName: eventName\n    };\n    this.addSubscription(subscription, eventName);\n    publication.onStop(() => {\n      this.removeSubscription(subscription, eventName);\n    });\n\n    if (useCollection === true) {\n      // Collection compatibility\n      publication._session.sendAdded(this.subscriptionName, 'id', {\n        eventName: eventName\n      });\n    }\n\n    publication.ready();\n  }\n\n  iniPublication() {\n    const stream = this;\n    Meteor.publish(this.subscriptionName, function (...args) {\n      return stream._publish.apply(stream, [this, ...args]);\n    });\n  }\n\n  initMethod() {\n    const stream = this;\n    const method = {};\n\n    method[this.subscriptionName] = function (eventName, ...args) {\n      check(eventName, String);\n      check(args, Array);\n      this.unblock();\n\n      if (stream.isWriteAllowed(this, eventName, args) !== true) {\n        return;\n      }\n\n      const methodScope = {\n        userId: this.userId,\n        connection: this.connection,\n        originalParams: args,\n        tranformed: false\n      };\n      args = stream.applyTransformers(methodScope, eventName, args);\n      stream.emitWithScope(eventName, methodScope, ...args);\n\n      if (stream.retransmit === true) {\n        stream._emit(eventName, args, this.connection, true);\n      }\n    };\n\n    try {\n      Meteor.methods(method);\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  _emit(eventName, args, origin, broadcast) {\n    if (broadcast === true) {\n      Meteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n    }\n\n    const subscriptions = this.subscriptionsByEventName[eventName];\n\n    if (!Array.isArray(subscriptions)) {\n      return;\n    }\n\n    const msg = changedPayload(this.subscriptionName, 'id', {\n      eventName,\n      args\n    });\n\n    if (!msg) {\n      return;\n    }\n\n    subscriptions.forEach(subscription => {\n      if (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n        return;\n      }\n\n      if (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n        send(subscription.subscription._session, msg);\n      }\n    });\n  }\n\n  emit(eventName, ...args) {\n    this._emit(eventName, args, undefined, true);\n  }\n\n  __emit(...args) {\n    return super.emit(...args);\n  }\n\n  emitWithoutBroadcast(eventName, ...args) {\n    this._emit(eventName, args, undefined, false);\n  }\n\n};","map":{"version":3,"sources":["packages/rocketchat:streamer/server/server.js"],"names":["DDPCommon","module","link","v","StreamerCentral","EV","constructor","instances","Meteor","changedPayload","collection","id","fields","_","isEmpty","stringifyDDP","msg","send","self","socket","Streamer","name","retransmit","retransmitToSelf","console","warn","subscriptions","subscriptionsByEventName","transformers","iniPublication","initMethod","_allowRead","_allowEmit","_allowWrite","allowRead","allowEmit","allowWrite","_name","check","String","subscriptionName","_retransmit","Boolean","_retransmitToSelf","eventName","fn","undefined","indexOf","error","userId","isReadAllowed","scope","args","call","isEmitAllowed","isWriteAllowed","addSubscription","subscription","push","removeSubscription","index","splice","transform","applyTransformers","methodScope","forEach","tranformed","Array","isArray","_publish","publication","options","Match","OneOf","useCollection","length","stop","Error","onStop","_session","sendAdded","ready","stream","publish","apply","method","unblock","connection","originalParams","emitWithScope","_emit","methods","e","origin","broadcast","emit","__emit","emitWithoutBroadcast"],"mappings":"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","sourcesContent":["/* globals EV */\n/* eslint new-cap: false */\nimport { DDPCommon } from 'meteor/ddp-common';\n\nclass StreamerCentral extends EV {\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.instances = {};\n\t}\n}\n\nMeteor.StreamerCentral = new StreamerCentral;\n\nconst changedPayload = function (collection, id, fields) {\n\tif (_.isEmpty(fields)) {\n\t\treturn;\n\t}\n\treturn DDPCommon.stringifyDDP({\n\t\tmsg: 'changed',\n\t\tcollection,\n\t\tid,\n\t\tfields\n\t});\n};\n\nconst send = function (self, msg) {\n\tif (!self.socket) {\n\t\treturn;\n\t}\n\tself.socket.send(msg);\n};\n\n\nMeteor.Streamer = class Streamer extends EV {\n\tconstructor(name, {retransmit = true, retransmitToSelf = false} = {}) {\n\t\tif (Meteor.StreamerCentral.instances[name]) {\n\t\t\tconsole.warn('Streamer instance already exists:', name);\n\t\t\treturn Meteor.StreamerCentral.instances[name];\n\t\t}\n\n\t\tsuper();\n\n\t\tMeteor.StreamerCentral.instances[name] = this;\n\n\t\tthis.name = name;\n\t\tthis.retransmit = retransmit;\n\t\tthis.retransmitToSelf = retransmitToSelf;\n\n\t\tthis.subscriptions = [];\n\t\tthis.subscriptionsByEventName = {};\n\t\tthis.transformers = {};\n\n\t\tthis.iniPublication();\n\t\tthis.initMethod();\n\n\t\tthis._allowRead = {};\n\t\tthis._allowEmit = {};\n\t\tthis._allowWrite = {};\n\n\t\tthis.allowRead('none');\n\t\tthis.allowEmit('all');\n\t\tthis.allowWrite('none');\n\t}\n\n\tget name() {\n\t\treturn this._name;\n\t}\n\n\tset name(name) {\n\t\tcheck(name, String);\n\t\tthis._name = name;\n\t}\n\n\tget subscriptionName() {\n\t\treturn `stream-${this.name}`;\n\t}\n\n\tget retransmit() {\n\t\treturn this._retransmit;\n\t}\n\n\tset retransmit(retransmit) {\n\t\tcheck(retransmit, Boolean);\n\t\tthis._retransmit = retransmit;\n\t}\n\n\tget retransmitToSelf() {\n\t\treturn this._retransmitToSelf;\n\t}\n\n\tset retransmitToSelf(retransmitToSelf) {\n\t\tcheck(retransmitToSelf, Boolean);\n\t\tthis._retransmitToSelf = retransmitToSelf;\n\t}\n\n\tallowRead(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowRead[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowRead[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowEmit(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowEmit[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowRead shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowEmit[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tallowWrite(eventName, fn) {\n\t\tif (fn === undefined) {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (typeof fn === 'function') {\n\t\t\treturn this._allowWrite[eventName] = fn;\n\t\t}\n\n\t\tif (typeof fn === 'string' && ['all', 'none', 'logged'].indexOf(fn) === -1) {\n\t\t\tconsole.error(`allowWrite shortcut '${fn}' is invalid`);\n\t\t}\n\n\t\tif (fn === 'all' || fn === true) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn true;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'none' || fn === false) {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn false;\n\t\t\t};\n\t\t}\n\n\t\tif (fn === 'logged') {\n\t\t\treturn this._allowWrite[eventName] = function() {\n\t\t\t\treturn Boolean(this.userId);\n\t\t\t};\n\t\t}\n\t}\n\n\tisReadAllowed(scope, eventName, args) {\n\t\tif (this._allowRead[eventName]) {\n\t\t\treturn this._allowRead[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowRead['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisEmitAllowed(scope, eventName, ...args) {\n\t\tif (this._allowEmit[eventName]) {\n\t\t\treturn this._allowEmit[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowEmit['__all__'].call(scope, eventName, ...args);\n\t}\n\n\tisWriteAllowed(scope, eventName, args) {\n\t\tif (this._allowWrite[eventName]) {\n\t\t\treturn this._allowWrite[eventName].call(scope, eventName, ...args);\n\t\t}\n\n\t\treturn this._allowWrite['__all__'].call(scope, eventName, ...args);\n\t}\n\n\taddSubscription(subscription, eventName) {\n\t\tthis.subscriptions.push(subscription);\n\n\t\tif (!this.subscriptionsByEventName[eventName]) {\n\t\t\tthis.subscriptionsByEventName[eventName] = [];\n\t\t}\n\n\t\tthis.subscriptionsByEventName[eventName].push(subscription);\n\t}\n\n\tremoveSubscription(subscription, eventName) {\n\t\tconst index = this.subscriptions.indexOf(subscription);\n\t\tif (index > -1) {\n\t\t\tthis.subscriptions.splice(index, 1);\n\t\t}\n\n\t\tif (this.subscriptionsByEventName[eventName]) {\n\t\t\tconst index = this.subscriptionsByEventName[eventName].indexOf(subscription);\n\t\t\tif (index > -1) {\n\t\t\t\tthis.subscriptionsByEventName[eventName].splice(index, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\ttransform(eventName, fn) {\n\t\tif (typeof eventName === 'function') {\n\t\t\tfn = eventName;\n\t\t\teventName = '__all__';\n\t\t}\n\n\t\tif (!this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName] = [];\n\t\t}\n\n\t\tthis.transformers[eventName].push(fn);\n\t}\n\n\tapplyTransformers(methodScope, eventName, args) {\n\t\tif (this.transformers['__all__']) {\n\t\t\tthis.transformers['__all__'].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, eventName, args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this.transformers[eventName]) {\n\t\t\tthis.transformers[eventName].forEach((transform) => {\n\t\t\t\targs = transform.call(methodScope, ...args);\n\t\t\t\tmethodScope.tranformed = true;\n\t\t\t\tif (!Array.isArray(args)) {\n\t\t\t\t\targs = [args];\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn args;\n\t}\n\n\n\t_publish(publication, eventName, options) {\n\t\tcheck(eventName, String);\n\t\tcheck(options, Match.OneOf(Boolean, {\n\t\t\tuseCollection: Boolean,\n\t\t\targs: Array,\n\t\t}));\n\n\t\tlet useCollection, args = [];\n\n\t\tif (typeof options === 'boolean') {\n\t\t\tuseCollection = options;\n\t\t} else {\n\t\t\tif (options.useCollection) {\n\t\t\t\tuseCollection = options.useCollection;\n\t\t\t}\n\n\t\t\tif (options.args) {\n\t\t\t\targs = options.args;\n\t\t\t}\n\t\t}\n\n\t\tif (eventName.length === 0) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('invalid-event-name');\n\t\t}\n\n\t\tif (this.isReadAllowed(publication, eventName, args) !== true) {\n\t\t\tpublication.stop();\n\t\t\tthrow new Meteor.Error('not-allowed');\n\t\t}\n\n\t\tconst subscription = {\n\t\t\tsubscription: publication,\n\t\t\teventName: eventName\n\t\t};\n\n\t\tthis.addSubscription(subscription, eventName);\n\n\t\tpublication.onStop(() => {\n\t\t\tthis.removeSubscription(subscription, eventName);\n\t\t});\n\n\t\tif (useCollection === true) {\n\t\t\t// Collection compatibility\n\t\t\tpublication._session.sendAdded(this.subscriptionName, 'id', {\n\t\t\t\teventName: eventName\n\t\t\t});\n\t\t}\n\n\t\tpublication.ready();\n\t}\n\n\tiniPublication() {\n\t\tconst stream = this;\n\t\tMeteor.publish(this.subscriptionName, function (...args) { return stream._publish.apply(stream, [this, ...args]); });\n\t}\n\n\tinitMethod() {\n\t\tconst stream = this;\n\t\tconst method = {};\n\n\t\tmethod[this.subscriptionName] = function(eventName, ...args) {\n\t\t\tcheck(eventName, String);\n\t\t\tcheck(args, Array);\n\n\t\t\tthis.unblock();\n\n\t\t\tif (stream.isWriteAllowed(this, eventName, args) !== true) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst methodScope = {\n\t\t\t\tuserId: this.userId,\n\t\t\t\tconnection: this.connection,\n\t\t\t\toriginalParams: args,\n\t\t\t\ttranformed: false\n\t\t\t};\n\n\t\t\targs = stream.applyTransformers(methodScope, eventName, args);\n\n\t\t\tstream.emitWithScope(eventName, methodScope, ...args);\n\n\t\t\tif (stream.retransmit === true) {\n\t\t\t\tstream._emit(eventName, args, this.connection, true);\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tMeteor.methods(method);\n\t\t} catch (e) {\n\t\t\tconsole.error(e);\n\t\t}\n\t}\n\n\t_emit(eventName, args, origin, broadcast) {\n\t\tif (broadcast === true) {\n\t\t\tMeteor.StreamerCentral.emit('broadcast', this.name, eventName, args);\n\t\t}\n\n\t\tconst subscriptions = this.subscriptionsByEventName[eventName];\n\t\tif (!Array.isArray(subscriptions)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst msg = changedPayload(this.subscriptionName, 'id', {\n\t\t\teventName,\n\t\t\targs\n\t\t});\n\n\t\tif(!msg) {\n\t\t\treturn;\n\t\t}\n\n\t\tsubscriptions.forEach((subscription) => {\n\t\t\tif (this.retransmitToSelf === false && origin && origin === subscription.subscription.connection) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.isEmitAllowed(subscription.subscription, eventName, ...args)) {\n\t\t\t\tsend(subscription.subscription._session, msg);\n\t\t\t}\n\t\t});\n\t}\n\n\temit(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, true);\n\t}\n\n\t__emit(...args) {\n\t\treturn super.emit(...args);\n\t}\n\n\temitWithoutBroadcast(eventName, ...args) {\n\t\tthis._emit(eventName, args, undefined, false);\n\t}\n};\n"]},"sourceType":"script","hash":"683a454acbc0866282f4404ff862adae5fbef637"}
