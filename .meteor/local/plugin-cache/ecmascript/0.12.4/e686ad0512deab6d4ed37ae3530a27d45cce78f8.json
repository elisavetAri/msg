{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"C:\\Sandbox\\test\\packages\\znewsham:dynamic-table\\client\\ui\\table.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","dynamicImport","classProperties","classPrivateProperties","jsx",["flow",{}],"asyncGenerators","objectRestSpread","objectRestSpread",["flow",{}],"asyncGenerators"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/znewsham:dynamic-table/client/ui/table.js","filename":"C:\\Sandbox\\test\\packages\\znewsham:dynamic-table\\client\\ui\\table.js","passPerPreset":false,"envName":"development","cwd":"C:\\Sandbox\\test","root":"C:\\Sandbox\\test","plugins":[{"key":"base$0$0","visitor":{"Program":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"generateLetDeclarations":true,"enforceStrictMode":false}},{"key":"transform-meteor-dynamic-import","visitor":{"_exploded":{},"_verified":{},"CallExpression":{"enter":[null]}},"options":{}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"_exploded":true,"_verified":true,"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-modules-commonjs","visitor":{"Program":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"allowTopLevelThis":true,"strictMode":false,"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-flow","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-flow-strip-types","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]},"ImportDeclaration":{"enter":[null,null]},"ClassProperty":{"enter":[null]},"ClassPrivateProperty":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"TypeCastExpression":{"enter":[null,null]},"CallExpression":{"enter":[null]},"OptionalCallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"ImportSpecifier":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"AnyTypeAnnotation":{"enter":[null]},"ArrayTypeAnnotation":{"enter":[null]},"BooleanTypeAnnotation":{"enter":[null]},"BooleanLiteralTypeAnnotation":{"enter":[null]},"NullLiteralTypeAnnotation":{"enter":[null]},"ClassImplements":{"enter":[null]},"DeclareClass":{"enter":[null]},"DeclareFunction":{"enter":[null]},"DeclareInterface":{"enter":[null]},"DeclareModule":{"enter":[null]},"DeclareModuleExports":{"enter":[null]},"DeclareTypeAlias":{"enter":[null]},"DeclareOpaqueType":{"enter":[null]},"DeclareVariable":{"enter":[null]},"DeclareExportDeclaration":{"enter":[null]},"DeclareExportAllDeclaration":{"enter":[null]},"DeclaredPredicate":{"enter":[null]},"ExistsTypeAnnotation":{"enter":[null]},"FunctionTypeAnnotation":{"enter":[null]},"FunctionTypeParam":{"enter":[null]},"GenericTypeAnnotation":{"enter":[null]},"InferredPredicate":{"enter":[null]},"InterfaceExtends":{"enter":[null]},"InterfaceDeclaration":{"enter":[null]},"InterfaceTypeAnnotation":{"enter":[null]},"IntersectionTypeAnnotation":{"enter":[null]},"MixedTypeAnnotation":{"enter":[null]},"EmptyTypeAnnotation":{"enter":[null]},"NullableTypeAnnotation":{"enter":[null]},"NumberLiteralTypeAnnotation":{"enter":[null]},"NumberTypeAnnotation":{"enter":[null]},"ObjectTypeAnnotation":{"enter":[null]},"ObjectTypeInternalSlot":{"enter":[null]},"ObjectTypeCallProperty":{"enter":[null]},"ObjectTypeIndexer":{"enter":[null]},"ObjectTypeProperty":{"enter":[null]},"ObjectTypeSpreadProperty":{"enter":[null]},"OpaqueType":{"enter":[null]},"QualifiedTypeIdentifier":{"enter":[null]},"StringLiteralTypeAnnotation":{"enter":[null]},"StringTypeAnnotation":{"enter":[null]},"ThisTypeAnnotation":{"enter":[null]},"TupleTypeAnnotation":{"enter":[null]},"TypeofTypeAnnotation":{"enter":[null]},"TypeAlias":{"enter":[null]},"TypeAnnotation":{"enter":[null]},"TypeParameter":{"enter":[null]},"TypeParameterDeclaration":{"enter":[null]},"TypeParameterInstantiation":{"enter":[null]},"UnionTypeAnnotation":{"enter":[null]},"Variance":{"enter":[null]},"VoidTypeAnnotation":{"enter":[null]},"ExportAllDeclaration":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"C:\\Sandbox\\test\\packages\\znewsham:dynamic-table\\client\\ui\\table.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/znewsham:dynamic-table/client/ui/table.js"}},"code":"let ReactiveVar;\nmodule.link(\"meteor/reactive-var\", {\n  ReactiveVar(v) {\n    ReactiveVar = v;\n  }\n\n}, 0);\nlet Modal;\nmodule.link(\"meteor/peppelg:bootstrap-3-modal\", {\n  Modal(v) {\n    Modal = v;\n  }\n\n}, 1);\nlet EJSON;\nmodule.link(\"meteor/ejson\", {\n  EJSON(v) {\n    EJSON = v;\n  }\n\n}, 2);\nmodule.link(\"./table.html\");\nmodule.link(\"./table.css\");\nmodule.link(\"./exportModal.js\");\nmodule.link(\"./components/filterModal/filterModal.js\");\nmodule.link(\"./advancedSearchModal.js\");\nmodule.link(\"./components/headerCell/headerCell.js\");\nmodule.link(\"./components/rawRender/rawRender.js\");\nmodule.link(\"./components/tableCell/tableCell.js\");\nmodule.link(\"./components/singleValueTextEditor/singleValueTextEditor.js\");\nmodule.link(\"./components/select2ValueEditor/select2ValueEditor.js\");\nlet getTableRecordsCollection;\nmodule.link(\"../db.js\", {\n  getTableRecordsCollection(v) {\n    getTableRecordsCollection = v;\n  }\n\n}, 3);\n\n/**\n  @this Template.instance()\n*/\nfunction doAdvancedSearch(extraOptions) {\n  const options = this.data.table;\n  const templateInstance = this;\n  Modal.show(\"dynamicTableAdvancedSearchModal\", _.extend({\n    beforeRender: options.advancedSearch.beforeRender,\n    collection: options.advancedSearch.collection || this.data.table.collection,\n    fields: options.advancedSearch.fields || _.compact(options.columns.map(column => column.data).filter(d => d !== \"_id\")),\n    columns: options.columns,\n    callback: options.advancedSearch.callback || (search => {\n      if (_.keys(search).length) {\n        templateInstance.$(\".advanced-search-button\").addClass(\"hasSearch\");\n      } else {\n        templateInstance.$(\".advanced-search-button\").removeClass(\"hasSearch\");\n      }\n\n      templateInstance.advancedSearch.set(search);\n      const query = templateInstance.query.get();\n      query.options.skip = 0;\n      templateInstance.query.set(query);\n      templateInstance.dataTable.api().page(0).draw(false);\n    }),\n    search: this.advancedSearch.get()\n  }, _.isObject(extraOptions) ? extraOptions : {}));\n}\n/**\n  @this Template.instance()\n*/\n\n\nfunction doExport(extraOptions) {\n  const query = this.query.get();\n  const templateInstance = this;\n  const advancedSearch = this.advancedSearch.get();\n\n  if (!query) {\n    return;\n  }\n\n  const queryOptions = query.options;\n  const querySelector = query.selector;\n  const table = this.data.table;\n\n  if (!table.export.fields) {\n    table.export.fields = this.columns.filter(column => column.data && column.data !== \"_id\").map(column => ({\n      field: column.data\n    }));\n  }\n\n  const schema = table.collection.simpleSchema && table.collection.simpleSchema();\n  table.export.fields = table.export.fields.map(field => {\n    if (!_.isObject(field)) {\n      field = {\n        field\n      };\n    }\n\n    if (!field.label) {\n      const column = _.findWhere(this.columns, {\n        data: field.field\n      });\n\n      if (column) {\n        field.label = column.titleFn ? column.titleFn() : column.title;\n      } else if (schema) {\n        field.label = schema.label(field.field) || field.field;\n      }\n    }\n\n    return field;\n  });\n\n  if (!table.export.fileName) {\n    table.export.fileName = this.data.id;\n  }\n\n  Modal.show(\"dynamicTableExportModal\", _.extend({}, {\n    tableId: this.data.id,\n    export: table.export,\n    publication: table.publication,\n    extraFields: table.extraFields || [],\n    compositePublicationNames: table.compositePublicationNames,\n    collection: table.collection,\n    advancedSearch: {},\n    selector: _.keys(advancedSearch).length ? {\n      $and: [querySelector, advancedSearch]\n    } : querySelector,\n    skip: queryOptions.skip || 0,\n    limit: queryOptions.limit,\n    sort: queryOptions.sort,\n    columns: this.columns\n  }, _.isObject(extraOptions) ? extraOptions : {}));\n}\n\nfunction filterModalCallback(columnIndex, optionsOrQuery, operator, sortDirection) {\n  let multiSort = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;\n  let redraw = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : true;\n  let forceChange = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : false;\n  const columns = this.dataTable.api().context[0].aoColumns;\n  const order = this.dataTable.api().order().map(o => ({\n    id: columns[o[0]].id,\n    data: columns[o[0]].data,\n    order: o[1]\n  }));\n  let fieldName = columns[columnIndex].data;\n\n  if (columns[columnIndex].filterModal && columns[columnIndex].filterModal.field && columns[columnIndex].filterModal.field.name) {\n    fieldName = columns[columnIndex].filterModal.field.name;\n  }\n\n  const existing = _.find(order, col => col.id && col.id === columns[columnIndex].id || col.data === columns[columnIndex].data);\n\n  let changed = false;\n\n  if (sortDirection !== undefined) {\n    if (existing) {\n      changed = existing.order !== (sortDirection === 1 ? \"asc\" : \"desc\");\n      existing.order = sortDirection === 1 ? \"asc\" : \"desc\";\n    } else if (multiSort) {\n      order.push({\n        id: columns[columnIndex].id,\n        data: columns[columnIndex].data,\n        order: sortDirection === 1 ? \"asc\" : \"desc\"\n      });\n      changed = true;\n    } else {\n      order.splice(0, order.length, {\n        id: columns[columnIndex].id,\n        data: columns[columnIndex].data,\n        order: sortDirection === 1 ? \"asc\" : \"desc\"\n      });\n    }\n\n    this.dataTable.api().order(order.map(o => {\n      const column = _.find(columns, c => c.id && c.id === o.id || c.data === o.data);\n\n      return [columns.indexOf(column), o.order];\n    }));\n  } // NOTE: we only want to run this code when triggered, not by an advanced search change.\n\n\n  const advancedSearch = Tracker.nonreactive(() => this.advancedSearch.get());\n  const startsWith = !columns[columnIndex].fullSearch; // NOTE: added .length to ensure correctness when disabling all options (e.g., add diagrams modal)\n\n  if (optionsOrQuery && optionsOrQuery.length) {\n    let newAdvancedSearchField;\n\n    if (operator === \"$between\") {\n      newAdvancedSearchField = {\n        $lte: optionsOrQuery[1],\n        $gte: optionsOrQuery[0]\n      };\n    } else if (operator === \"$gte\" || operator === \"$lte\") {\n      newAdvancedSearchField = {\n        [operator]: optionsOrQuery\n      };\n    } else if (_.isArray(optionsOrQuery) && optionsOrQuery.length) {\n      if (operator === \"$not$all\") {\n        newAdvancedSearchField = {\n          $not: {\n            $all: optionsOrQuery\n          }\n        };\n      } else {\n        newAdvancedSearchField = {\n          [operator]: optionsOrQuery\n        };\n      }\n    } else if (!_.isArray(optionsOrQuery) && optionsOrQuery !== \"\") {\n      newAdvancedSearchField = operator === \"$regex\" ? {\n        $regex: \"\".concat(startsWith ? \"^\" : \"\").concat(optionsOrQuery)\n      } : {\n        $not: new RegExp(\"\".concat(startsWith ? \"^\" : \"\").concat(optionsOrQuery))\n      };\n    }\n\n    if (columns[columnIndex].search) {\n      newAdvancedSearchField = columns[columnIndex].search(_.extend({}, newAdvancedSearchField, {\n        $options: columns[columnIndex].searchOptions\n      }), false);\n      let arrayToReplaceIn = advancedSearch.$and || [];\n      let found = false;\n      arrayToReplaceIn = arrayToReplaceIn.map(obj => {\n        const arr = obj.$or || obj.$and;\n\n        if (_.isArray(newAdvancedSearchField)) {\n          const matches = newAdvancedSearchField.some(searchObj => arr.find(oldObj => _.isEqual(_.sortBy(_.keys(searchObj)), _.sortBy(_.keys(oldObj)))));\n\n          if (matches) {\n            found = true;\n            return {\n              [obj.$or ? \"$or\" : \"$and\"]: newAdvancedSearchField\n            };\n          }\n        } else {\n          const matches = _.isEqual(_.sortBy(_.keys(newAdvancedSearchField)), _.sortBy(_.keys(obj)));\n\n          if (matches) {\n            found = true;\n            return newAdvancedSearchField;\n          }\n        }\n\n        return obj;\n      });\n\n      if (!found) {\n        if (_.isArray(newAdvancedSearchField)) {\n          const someOperator = [\"$regex\", \"$in\"].includes(operator) ? \"$or\" : \"$and\";\n          arrayToReplaceIn.push({\n            [someOperator]: newAdvancedSearchField\n          });\n        } else {\n          arrayToReplaceIn.push(newAdvancedSearchField);\n        }\n      }\n\n      if (!EJSON.equals(EJSON.toJSONValue(arrayToReplaceIn), EJSON.toJSONValue(advancedSearch.$and))) {\n        advancedSearch.$and = arrayToReplaceIn;\n        this.advancedSearch.set(advancedSearch);\n        changed = true;\n      }\n    } else if (!EJSON.equals(EJSON.toJSONValue(advancedSearch[fieldName]), EJSON.toJSONValue(newAdvancedSearchField))) {\n      if (newAdvancedSearchField) {\n        advancedSearch[fieldName] = _.extend({}, newAdvancedSearchField, {\n          $options: columns[columnIndex].searchOptions\n        });\n      }\n\n      this.advancedSearch.set(advancedSearch);\n      changed = true;\n    }\n  } else if (fieldName && advancedSearch[fieldName]) {\n    delete advancedSearch[fieldName];\n    this.advancedSearch.set(advancedSearch);\n    changed = true;\n  } else if (columns[columnIndex].search) {\n    const searchResult = columns[columnIndex].search({\n      $regex: \"\"\n    });\n    let arrayToReplaceIn = advancedSearch.$and || [];\n    arrayToReplaceIn = arrayToReplaceIn.map(obj => {\n      const arr = obj.$or || obj.$and;\n\n      if (_.isArray(searchResult)) {\n        const matches = searchResult.some(searchObj => arr.find(oldObj => _.isEqual(_.sortBy(_.keys(searchObj)), _.sortBy(_.keys(oldObj)))));\n\n        if (matches) {\n          return null;\n        }\n      } else {\n        const matches = _.isEqual(_.sortBy(_.keys(searchResult)), _.sortBy(_.keys(obj)));\n\n        if (matches) {\n          return null;\n        }\n      }\n\n      return obj;\n    });\n    arrayToReplaceIn = _.compact(arrayToReplaceIn);\n\n    if (arrayToReplaceIn && arrayToReplaceIn.length) {\n      advancedSearch.$and = arrayToReplaceIn;\n    } else {\n      delete advancedSearch.$and;\n    }\n\n    this.advancedSearch.set(advancedSearch);\n    changed = true;\n  }\n\n  if (changed || forceChange) {\n    if (this.data.modifyFilterCallback) {\n      this.data.modifyFilterCallback(advancedSearch, order, columns);\n    }\n\n    if (redraw) {\n      this.dataTable.loading.set(true);\n      this.dataTable.api().draw();\n    }\n  }\n}\n/**\n  @this Template.instance()\n*/\n\n\nfunction setup() {\n  const self = this;\n  const currentData = Tracker.nonreactive(() => Template.currentData());\n  self.query.set(null); // NOTE: allow for subscription managers.\n\n  self.subManager = currentData.table.sub;\n\n  if (!self.subManager) {\n    self.subManager = currentData.table.collection._connection || Meteor;\n  } // NOTE: ensure we have clean data.\n\n\n  currentData.table.extraFields = currentData.table.extraFields || [];\n  self.columns = (currentData.table.columns || []).map(c => _.extend({}, c));\n  self.columns.forEach(column => {\n    if (column.tmpl || column.editTmpl) {\n      if (!column.defaultContent) {\n        column.defaultContent = \"\";\n      }\n\n      const templateName = column.tmpl && column.tmpl.viewName || \"Template.dynamicTableRawRender\";\n\n      column.createdCell = function createdCell(td, value, rowData, row, col) {\n        const rawRowData = rowData;\n        const rawContent = td.innerHTML !== undefined ? td.innerHTML : value;\n        td.innerHTML = \"\";\n\n        if (column.tmplContext && rowData) {\n          rowData = column.tmplContext(rowData, self.data);\n        }\n\n        const editRowData = {\n          doc: rawRowData,\n          column,\n          collection: currentData.table.collection\n        };\n        const enableEdit = column.enableEdit ? column.enableEdit(rawRowData) : true;\n\n        if (self.blaze[\"\".concat(row, \"-\").concat(col)]) {\n          if (self.blaze[\"\".concat(row, \"-\").concat(col)].name === templateName && self.blaze[\"\".concat(row, \"-\").concat(col)].idOrData === (column.id || column.data)) {\n            td.parentElement.replaceChild(self.blaze[\"\".concat(row, \"-\").concat(col)].cell, td);\n            self.blaze[\"\".concat(row, \"-\").concat(col)].tmpl.dataVar.set({\n              editable: !!column.editTmpl && enableEdit,\n              templateName: templateName.split(\".\")[1],\n              templateData: column.tmpl ? rowData : rawContent,\n              editTemplateName: column.editTmpl && column.editTmpl.viewName.split(\".\")[1],\n              editTemplateData: column.editTmplContext ? column.editTmplContext(editRowData) : editRowData\n            });\n            return self.blaze[\"\".concat(row, \"-\").concat(col)].tmpl;\n          }\n\n          delete self.blaze[\"\".concat(row, \"-\").concat(col)];\n        }\n\n        const ret = Blaze.renderWithData(Template.dynamicTableTableCell, {\n          editable: !!column.editTmpl && enableEdit,\n          templateName: templateName.split(\".\")[1],\n          templateData: column.tmpl ? rowData : rawContent,\n          editTemplateName: column.editTmpl && column.editTmpl.viewName.split(\".\")[1],\n          editTemplateData: column.editTmplContext ? column.editTmplContext(editRowData) : editRowData\n        }, td, self.view);\n        self.blaze[\"\".concat(row, \"-\").concat(col)] = {\n          idOrData: column.id || column.data,\n          name: templateName,\n          cell: td,\n          tmpl: ret\n        };\n        return ret;\n      };\n\n      if (!column.render && column.data) {\n        column.render = function render(data, type) {\n          // NOTE: changing this causes problems above with rawContent, why it needs to be \"\" (versus the value or undefined) is anyones guess.\n          return data; // type === \"display\" ? \"\" : data;\n        };\n      }\n    }\n\n    if (!column.defaultContent) {\n      column.defaultContent = column.defaultContent || \"\";\n    }\n  });\n\n  if (currentData.table.search === undefined) {\n    currentData.table.search = {\n      caseInsensitive: true,\n      regex: true\n    };\n  } else {\n    if (currentData.table.search.caseInsensitive === undefined) {\n      currentData.table.search.caseInsensitive = true;\n    }\n\n    if (currentData.table.search.regex === undefined) {\n      currentData.table.search.regex = true;\n    }\n  }\n}\n/**\n  @param data Object - the first argument to the ajax call\n  @param options Object - the global options of the data subscription\n  @param currentData Object - the arguments passed into the template.\n*/\n\n\nfunction ajaxOptions(data, options, columns) {\n  const pageOptions = {\n    skip: data.start\n  };\n\n  if (data.length && data.length !== -1) {\n    pageOptions.limit = data.length;\n  }\n\n  if (data.order) {\n    pageOptions.sort = {};\n    data.order.forEach((order, index) => {\n      if (columns[order.column] && (columns[order.column].data || columns[order.column].sortField)) {\n        if (columns[order.column].sortField) {\n          pageOptions.sort[columns[order.column].sortField] = 1 * (order.dir === \"desc\" ? -1 : 1);\n        } else {\n          pageOptions.sort[columns[order.column].data] = 1 * (order.dir === \"desc\" ? -1 : 1);\n        }\n      }\n    });\n  }\n\n  return _.extend({}, options, pageOptions);\n}\n/**\n  @param data Object - the first argument to the ajax call\n  @param selector Object - the selector for the raw query (no search)\n  @param currentData Object - the arguments passed into the template.\n*/\n\n\nfunction ajaxSelector(data, selector, columns, caseInsensitive) {\n  const querySelector = _.extend({}, selector);\n\n  if (data.search && data.search.value !== \"\") {\n    querySelector.$or = [];\n    const search = data.search.regex || caseInsensitive ? {\n      $regex: data.search.value.split(\"\\\\\").join(\"\\\\\\\\\")\n    } : data.search.value;\n\n    if (caseInsensitive) {\n      search.$options = \"i\";\n    }\n\n    columns.forEach(column => {\n      if (_.isFunction(column.search)) {\n        querySelector.$or = _.union(querySelector.$or, column.search(search, Meteor.userId()));\n      } else if (column.data && column.searchable !== false) {\n        querySelector.$or.push({\n          [column.data]: search\n        });\n      }\n    });\n  }\n\n  return querySelector;\n}\n\nfunction getOptions(currentData, columns) {\n  // NOTE: we want all fields defined in columns + all extraFields\n  let fields = _.union(_.unique(_.compact(_.pluck(columns, \"data\"))), currentData.table.extraFields);\n\n  fields = fields.filter(field => field.includes && (!field.includes(\".\") || !fields.includes(field.split(\".\")[0])));\n\n  const fieldsObject = _.object(fields, _.times(fields.length, () => true));\n\n  const options = _.extend({\n    fields: fieldsObject\n  }, currentData.table.subscriptionOptions || {}); // NOTE: if we have a hard limit (e.g., no paging specified)\n\n\n  if (currentData.table.limit) {\n    options.limit = currentData.table.limit;\n  }\n\n  return options;\n}\n\nTemplate.DynamicTable.onRendered(function onRendered() {\n  const self = this;\n  const templateInstance = this;\n  this.$tableElement = $(this.$(\"table\")[0]);\n  let lastId;\n\n  if (this.data.table.export) {\n    this.$tableElement.data(\"do-export\", function () {\n      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n        args[_key] = arguments[_key];\n      }\n\n      doExport.apply(templateInstance, args);\n    });\n  }\n\n  if (this.data.table.advancedSearch) {\n    this.$tableElement.data(\"do-advancedSearch\", function () {\n      for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {\n        args[_key2] = arguments[_key2];\n      }\n\n      doAdvancedSearch.apply(templateInstance, args);\n    });\n  }\n\n  this.autorun(() => {\n    templateInstance.tableId.get();\n    const currentData = Tracker.nonreactive(() => Template.currentData()); // NOTE: intentionally not reactive.\n\n    setup.call(self);\n    const options = getOptions(currentData, self.columns); // TODO: left in for compatibility - to be removed.\n\n    const tableSpec = _.extend({\n      serverSide: true,\n\n      initComplete() {\n        const table = templateInstance.data.table;\n\n        if (table.advancedSearch) {\n          const advancedSearchButton = currentData.table.advancedSearch.buttonHtml ? $(currentData.table.advancedSearch.buttonHtml) : $(\"<buton>\").addClass(\"advanced-search-button\").addClass(\"btn btn-default\").html(\"<i class='fa fa-search'></i>\").css(\"margin-top\", \"-10px\");\n          templateInstance.$(\".dataTables_filter>label\").append(advancedSearchButton);\n        }\n\n        if (table.search && table.search.onEnterOnly) {\n          const replaceSearchLabel = newText => {\n            $(\".dataTables_filter label\").contents().filter(function filter() {\n              return this.nodeType === 3 && this.textContent.trim().length;\n            }).replaceWith(newText);\n          };\n\n          $(\".dataTables_filter input\").unbind().bind(\"keyup change\", event => {\n            if (!templateInstance.dataTable) return;\n\n            if (event.keyCode === 13 || this.value === \"\") {\n              replaceSearchLabel(\"Search:\");\n              templateInstance.dataTable.search(this.value).draw();\n            } else {\n              replaceSearchLabel(\"Search (hit enter):\");\n            }\n          });\n        }\n      },\n\n      headerCallback(headerRow) {\n        const columns = self.dataTable.fnSettings().aoColumns;\n        $(headerRow).find(\"td,th\").each((index, headerCell) => {\n          if (columns[index].titleTmpl) {\n            if (headerCell.__blazeViewInstance) {\n              Blaze.remove(headerCell.__blazeViewInstance);\n            }\n\n            headerCell.innerHTML = \"\";\n            headerCell.__blazeViewInstance = Blaze.renderWithData(columns[index].titleTmpl, columns[index].titleTmplContext ? columns[index].titleTmplContext(templateInstance.data) : {}, headerCell);\n          } else if (columns[index].filterModal) {\n            if (headerCell.__blazeViewInstance) {\n              Blaze.remove(headerCell.__blazeViewInstance);\n            }\n\n            headerCell.innerHTML = \"\";\n            headerCell.__blazeViewInstance = Blaze.renderWithData(Template.dynamicTableHeaderCell, {\n              column: columns[index],\n              columnIndex: index,\n              table: currentData.table,\n              dataTable: templateInstance.dataTable,\n              advancedSearch: templateInstance.advancedSearch.get(),\n              filterModalCallback: filterModalCallback.bind(self),\n              removeColumn: templateInstance.data.removeColumn\n            }, headerCell);\n          } else {\n            const titleFunction = columns[index] && columns[index].titleFn;\n\n            if (typeof titleFunction === \"function\") {\n              headerCell.innerHTML = titleFunction();\n            }\n          }\n        });\n      },\n\n      ajax(data, callback) {\n        const _selector = Tracker.nonreactive(() => templateInstance.selector.get());\n\n        const selector = currentData.table.changeSelector ? currentData.table.changeSelector(_selector || {}) : _selector || {};\n        templateInstance.completeStart = new Date().getTime();\n        const columns = self.dataTable && self.dataTable.api().context && self.dataTable.api().context[0] ? self.dataTable.api().context[0].aoColumns : self.columns;\n        const options = getOptions(currentData, columns); // NOTE: the \"ajax\" call triggers a subscription rerun, iff queryOptions or querySelector has changed\n\n        const queryOptions = ajaxOptions(data, options, columns);\n        const querySelector = ajaxSelector(data, selector, columns, currentData.table.search.caseInsensitive);\n        const query = {\n          options: queryOptions,\n          selector: querySelector\n        };\n        const oldQuery = Tracker.nonreactive(() => self.query.get());\n\n        if (oldQuery && JSON.stringify(oldQuery && oldQuery.options && oldQuery.options.sort) !== JSON.stringify(queryOptions.sort)) {\n          templateInstance.sorting = true;\n        }\n\n        if (JSON.stringify(Tracker.nonreactive(() => self.query.get())) !== JSON.stringify(query)) {\n          self.query.set(query);\n          templateInstance.ajaxCallback = callback;\n        }\n      }\n\n    }, currentData.table, {\n      columns: templateInstance.columns\n    });\n\n    if (templateInstance.dataTable) {\n      templateInstance.dataTable.isReady = false;\n      templateInstance.dataTable.api().destroy();\n\n      if (currentData.id !== lastId) {\n        templateInstance.$(\"#\".concat(currentData.id)).html(\"\");\n      } else {\n        templateInstance.$(\"#\".concat(currentData.id)).find(\"thead\").html(\"\");\n      }\n    }\n\n    lastId = currentData.id;\n\n    tableSpec.drawCallback = () => {\n      templateInstance.dataTable.loading.set(false);\n    };\n\n    templateInstance.dataTable = templateInstance.$(\"#\".concat(currentData.id)).dataTable(tableSpec);\n    templateInstance.$(\"#\".concat(currentData.id)).on(\"init.dt\", () => {\n      if (currentData.table.pageNumber) {\n        templateInstance.dataTable.api().page(currentData.table.pageNumber).draw(false);\n      }\n\n      templateInstance.dataTable.isReady = true;\n    });\n\n    if (tableSpec.lengthChangeCallback) {\n      templateInstance.$(\"#\".concat(currentData.id)).on(\"length.dt\", (e, settings, len) => {\n        if (!templateInstance.dataTable.isReady) {\n          return;\n        }\n\n        tableSpec.lengthChangeCallback(templateInstance.dataTable, len);\n      });\n    }\n\n    if (tableSpec.pageChangeCallback) {\n      templateInstance.$(\"#\".concat(currentData.id)).on(\"page.dt\", () => {\n        if (!templateInstance.dataTable.isReady) {\n          return;\n        }\n\n        tableSpec.pageChangeCallback(templateInstance.dataTable, templateInstance.dataTable.api().page());\n      });\n    }\n\n    if (tableSpec.orderCallback) {\n      templateInstance.$(\"#\".concat(currentData.id)).on(\"order.dt\", () => {\n        if (!templateInstance.dataTable.isReady) {\n          return;\n        }\n\n        if (tableSpec.orderCallback) {\n          tableSpec.orderCallback(templateInstance.dataTable, templateInstance.dataTable.api().order());\n        }\n      });\n    }\n\n    if (tableSpec.sortable) {\n      templateInstance.$(\"#\".concat(currentData.id, \">tbody\")).sortable(tableSpec.sortable);\n    }\n\n    templateInstance.dataTable.loading = new ReactiveVar(true);\n  }); // NOTE: initialize the subscription according to the query options/selector\n\n  this.autorun(() => {\n    const currentData = templateInstance.data;\n    const query = templateInstance.query.get();\n\n    if (!query) {\n      return;\n    }\n\n    const queryOptions = query.options;\n    const querySelector = query.selector;\n    const advancedSearch = templateInstance.advancedSearch.get(); // NOTE: we dont want to rerun this since we're setting it just below\n\n    let newSub;\n    const subToStop = Tracker.nonreactive(() => {\n      if (templateInstance.sub.get()) {\n        if (templateInstance.sub.get().stop) {\n          return templateInstance.sub.get();\n        }\n\n        self.subManager.clear();\n      }\n    });\n\n    if (!currentData.table.publication) {\n      templateInstance.loaded.set(true);\n      return;\n    }\n\n    if (currentData.table.useArrayPublication || currentData.table.useArrayPublication === undefined && (!currentData.table.compositePublicationNames || currentData.table.compositePublicationNames.length === 0)) {\n      templateInstance.loaded.set(false);\n      newSub = self.subManager.subscribe(\"__dynamicTableResultsArray\", currentData.id, currentData.table.publication, _.keys(advancedSearch).length ? {\n        $and: [querySelector, advancedSearch]\n      } : querySelector, queryOptions);\n      templateInstance.sub.set(newSub);\n    } else {\n      templateInstance.loaded.set(false);\n      newSub = self.subManager.subscribe(\"__dynamicTableResults\", currentData.id, currentData.table.publication, currentData.table.compositePublicationNames, _.keys(advancedSearch).length ? {\n        $and: [querySelector, advancedSearch]\n      } : querySelector, queryOptions);\n      templateInstance.sub.set(newSub);\n    }\n\n    if (subToStop && subToStop !== newSub && subToStop.subscriptionId !== newSub.subscriptionId) {\n      subToStop.stop();\n    }\n  }); // NOTE: wait for the subscription and then fetch and observe the data.\n\n  this.autorun(() => {\n    const ajaxCallback = templateInstance.ajaxCallback;\n    templateInstance.tableId.get();\n    const currentData = templateInstance.data;\n    const query = templateInstance.query.get();\n\n    if (!query) {\n      return;\n    }\n\n    const queryOptions = query.options;\n    let tableInfo = getTableRecordsCollection(currentData.table.collection._connection).findOne({\n      _id: currentData.id\n    });\n\n    if (!tableInfo && (Meteor.status().status === \"offline\" || !currentData.table.publication)) {\n      const advancedSearch = templateInstance.advancedSearch.get();\n\n      const options = _.extend({}, query.options);\n\n      delete options.limit;\n      delete options.skip;\n      options.fields = {\n        _id: true\n      };\n      const data = currentData.table.collection.find(_.keys(advancedSearch).length ? {\n        $and: [query.selector, advancedSearch]\n      } : query.selector, options).fetch();\n      tableInfo = {\n        recordsFiltered: data.length,\n        recordsTotal: data.length,\n        _ids: data.slice(queryOptions.skip || 0, (queryOptions.skip || 0) + (queryOptions.limit || 10000000)).map(i => i._id)\n      };\n    }\n\n    if ((!currentData.table.publication || templateInstance.sub.get() && templateInstance.sub.get().ready()) && tableInfo) {\n      templateInstance.loaded.set(true);\n\n      if (templateInstance.handle) {\n        templateInstance.handle.stop();\n      }\n\n      let initializing = true; // NOTE: tableInfo._ids already contains the ids of the documents to find - so no skip\n\n      const cursor = Tracker.nonreactive(() => currentData.table.collection.find({\n        _id: {\n          $in: tableInfo._ids\n        }\n      }, _.omit(queryOptions, \"skip\")));\n      const count = cursor.count(); // MUST BE REACTIVE to track document removals and additions in the case that we hit this line before all data is really added.\n\n      let docs = Tracker.nonreactive(() => cursor.fetch());\n\n      if (!this.sorting && currentData.table.sort) {\n        docs = _.sortBy(docs, currentData.table.sort);\n      }\n\n      templateInstance.handle = cursor.observeChanges({\n        _suppress_initial: true,\n\n        // NOTE: the entire autorun block reruns when data is added/removed\n        addedBefore() {},\n\n        // NOTE:\n        //      the entire autorun block reruns when data is moved in the sorted list\n        //      (because tableInfo returns a new sortd list)\n        //      a big optimization would be to not re-render the entire table on this\n        //      just the rows that have changed, which could be the entire table :(\n        movedBefore() {},\n\n        // NOTE: when a document is changed, right now just re-render the entire row\n        //       a future optimization would be to just re-render the cell that has changed.\n        changed(_id) {\n          if (!initializing) {\n            // NOTE: we can't rely on tableInfo._ids being in order as we might run the sort locally.\n            // const rowIndex = tableInfo._ids.indexOf(_id);\n            const rowsData = _.toArray(templateInstance.dataTable.api().data());\n\n            const rowIndex = rowsData.indexOf(_.findWhere(rowsData, {\n              _id\n            }));\n            const rowData = currentData.table.collection.findOne({\n              _id\n            });\n            const columns = templateInstance.dataTable.fnSettings().aoColumns;\n\n            try {\n              const row = templateInstance.dataTable.api().row(rowIndex);\n              row.context[0].aoData[row[0]]._aData = rowData;\n              $(templateInstance.dataTable.api().row(rowIndex).node()).find(\"td,th\").each(cellIndex => {\n                const column = columns[cellIndex];\n\n                if (column.tmpl || column.editTmpl) {\n                  let changed = false;\n                  const templateName = columns[cellIndex].tmpl && columns[cellIndex].tmpl.viewName || \"Template.dynamicTableRawRender\";\n\n                  if (templateInstance.blaze[\"\".concat(rowIndex, \"-\").concat(cellIndex)].tmpl && templateInstance.blaze[\"\".concat(rowIndex, \"-\").concat(cellIndex)].name === templateName && templateInstance.blaze[\"\".concat(rowIndex, \"-\").concat(cellIndex)].idOrData === (columns[cellIndex].id || columns[cellIndex].data)) {\n                    const oldData = templateInstance.blaze[\"\".concat(rowIndex, \"-\").concat(cellIndex)].tmpl.dataVar.get();\n\n                    if (columns[cellIndex].tmpl) {\n                      const newData = columns[cellIndex].tmplContext ? columns[cellIndex].tmplContext(rowData, templateInstance.data) : rowData;\n\n                      try {\n                        if (JSON.stringify(oldData.templateData) !== JSON.stringify(newData)) {\n                          oldData.templateData = newData;\n                          changed = true;\n                        }\n                      } catch (e) {\n                        oldData.templateData = newData;\n                        changed = true;\n                      }\n                    } else {\n                      const newData = templateInstance.dataTable.api().cell(rowIndex, cellIndex).render(\"data\");\n\n                      try {\n                        if (JSON.stringify(oldData.templateData) !== JSON.stringify(newData)) {\n                          oldData.templateData = newData;\n                          changed = true;\n                        }\n                      } catch (e) {\n                        oldData.templateData = newData;\n                        changed = true;\n                      }\n                    }\n\n                    const editRowData = {\n                      doc: rowData,\n                      column: templateInstance.columns[cellIndex],\n                      collection: templateInstance.data.table.collection\n                    };\n                    const newData = templateInstance.columns[cellIndex].editTmplContext ? templateInstance.columns[cellIndex].editTmplContext(editRowData) : editRowData;\n                    oldData.editTemplateData = newData;\n\n                    if (changed) {\n                      templateInstance.blaze[\"\".concat(rowIndex, \"-\").concat(cellIndex)].tmpl.dataVar.set(oldData);\n                    }\n                  }\n                } else {\n                  templateInstance.dataTable.api().cell(rowIndex, cellIndex).invalidate();\n                }\n              });\n            } catch (e) {\n              console.log(e);\n            }\n          }\n        }\n\n      });\n      initializing = false;\n\n      if (count < tableInfo._ids.length) {\n        return;\n      } // NOTE: if we have all the fields we need to sort on, we dont need to use the non-oplog observe call on the server, but we have to sort client side.\n\n\n      const hasSortableFields = !this.sorting && currentData.table.sort || _.keys(queryOptions.fields || {}).length === 0 || _.intersection(_.keys(queryOptions.fields || {}), _.keys(queryOptions.sort || {})).length === _.keys(queryOptions.sort || {}).length;\n\n      ajaxCallback({\n        data: hasSortableFields ? docs : _.sortBy(docs, row => tableInfo._ids.indexOf(row._id)),\n        recordsFiltered: tableInfo.recordsFiltered,\n        recordsTotal: tableInfo.recordsTotal\n      });\n\n      if (this.sorting && currentData.table.sortable) {\n        currentData.table.sortable.stop();\n      }\n\n      this.sorting = false;\n    }\n  });\n});\nlet wrappedColReorder = false;\nTemplate.DynamicTable.onCreated(function onCreated() {\n  const self = this;\n\n  if (!wrappedColReorder && $.fn.dataTableExt.oApi.fnColReorder) {\n    wrappedColReorder = true;\n    const oldFnColReorder = $.fn.dataTableExt.oApi.fnColReorder;\n\n    $.fn.dataTableExt.oApi.fnColReorder = function fnColReorder() {\n      for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {\n        args[_key3] = arguments[_key3];\n      }\n\n      while (args.length < 5) {\n        args.push(undefined);\n      }\n\n      if (args[args.length - 1] === undefined) {\n        args[args.length - 1] = false;\n      }\n\n      oldFnColReorder.apply(this, args);\n    };\n  }\n\n  this.loaded = new ReactiveVar(true);\n  this.sub = new ReactiveVar(null);\n  this.selector = new ReactiveVar({});\n  this.options = new ReactiveVar({});\n  this.query = new ReactiveVar(false);\n  this.advancedSearch = new ReactiveVar(EJSON.fromJSONValue(this.data.advancedFilter || {}));\n  this.incomingSelector = new ReactiveVar({});\n  this.tableId = new ReactiveVar(\"\");\n  this._columns = new ReactiveVar([]);\n\n  this.documentMouseDown = e => {\n    const filterModalWrapper = $(\"#dynamic-table-filter-modal\")[0];\n\n    if (filterModalWrapper) {\n      if ($(filterModalWrapper).has(e.target).length) {\n        return;\n      }\n\n      Blaze.remove(filterModalWrapper.__blazeTemplate);\n      filterModalWrapper.innerHTML = \"\";\n    }\n\n    const manageFieldsWrapper = $(\"#dynamic-table-manage-fields-modal\")[0];\n\n    if (manageFieldsWrapper) {\n      if ($(manageFieldsWrapper).has(e.target).length) {\n        return;\n      }\n\n      Blaze.remove(manageFieldsWrapper.__blazeTemplate);\n      manageFieldsWrapper.innerHTML = \"\";\n    }\n  };\n\n  document.addEventListener(\"mousedown\", this.documentMouseDown);\n  let oldColumns;\n  this.autorun(comp => {\n    const columns = this._columns.get();\n\n    if (comp.firstRun) {\n      oldColumns = this.data.table.columns;\n      return;\n    }\n\n    if (columns.length < oldColumns.length) {\n      const context = this.dataTable.api().context[0];\n      const missingColumn = context.aoColumns.find(nc => !_.find(columns, oc => oc._id ? oc._id === nc._id : oc.data === nc.data));\n      let index = missingColumn.idx;\n      const tdorh = this.$(\"thead\").find(\"td[data-column-index=\".concat(index, \"],th[data-column-index=\").concat(index, \"]\"))[0];\n\n      if (tdorh) {\n        // NOTE: data-column-index is only added when colReorder is used\n        index = _.toArray(this.$(\"thead>tr\")[0].children).indexOf(tdorh);\n      }\n\n      this.$(\"thead\").find(\"td:nth-child(\".concat(index + 1, \"),th:nth-child(\").concat(index + 1, \")\")).remove();\n      this.$(\"tbody>tr\").find(\"td:nth-child(\".concat(index + 1, \"),th:nth-child(\").concat(index + 1, \")\")).remove();\n      this.dataTable.api().context[0].aoColumns.splice(index, 1);\n      this.dataTable.api().context[0].aoData[0].anCells.splice(index, 1);\n      this.blaze = {};\n    } else {\n      Tracker.afterFlush(() => {\n        this.tableId.dep.changed();\n\n        if (self.dataTable) {\n          self.dataTable.api().ajax.reload();\n        }\n      });\n    }\n\n    oldColumns = columns;\n  });\n  let forceRefresh;\n  this.autorun(() => {\n    const currentData = Template.currentData();\n\n    if (forceRefresh && forceRefresh !== currentData.forceRefresh) {\n      this.tableId.dep.changed();\n    }\n\n    forceRefresh = currentData.forceRefresh;\n  });\n  this.autorun(() => {\n    const currentData = Template.currentData();\n\n    if (Tracker.nonreactive(() => self.tableId.get()) !== currentData.id) {\n      oldColumns = currentData.table.columns.slice(0);\n      self.tableId.set(currentData.id);\n      oldColumns = currentData.table.columns.slice(0);\n    } else if (Tracker.nonreactive(() => self._columns.get().length) !== currentData.table.columns.length) {\n      if (!oldColumns) {\n        oldColumns = currentData.table.columns;\n      }\n\n      self._columns.set(currentData.table.columns.slice(0));\n    }\n\n    if (JSON.stringify(Tracker.nonreactive(() => self.selector.get())) !== JSON.stringify(currentData.selector)) {\n      self.selector.set(currentData.selector);\n\n      if (self.dataTable) {\n        self.dataTable.api().ajax.reload();\n      }\n    }\n  });\n  this.blaze = {};\n}); // NOTE: cleanup\n//       stop the subscription\n//       stop the observer\n//       destroy the data table and empty the actual table element\n\nTemplate.DynamicTable.onDestroyed(function onDestroyed() {\n  document.removeEventListener(\"mousedown\", this.documentMouseDown);\n\n  if (this.sub.get()) {\n    if (this.sub.get().stop) {\n      this.sub.get().stop();\n    } else {\n      this.subManager.clear();\n    }\n  }\n\n  if (this.handle) {\n    this.handle.stop();\n  }\n\n  if (this.tableElement && this.$tableElement.length) {\n    const dt = this.$tableElement.DataTable();\n\n    if (dt) {\n      dt.destroy();\n    } // this.$tableElement.html(\"\");\n\n  }\n});\nTemplate.DynamicTable.events({\n  \"click .advanced-search-button\"() {\n    doAdvancedSearch.call(Template.instance());\n  }\n\n});\nTemplate.DynamicTable.helpers({\n  loaded() {\n    return Template.instance().loaded.get();\n  }\n\n});","map":{"version":3,"sources":["packages/znewsham:dynamic-table/client/ui/table.js"],"names":["ReactiveVar","module","link","v","Modal","EJSON","getTableRecordsCollection","doAdvancedSearch","extraOptions","options","data","table","templateInstance","show","_","extend","beforeRender","advancedSearch","collection","fields","compact","columns","map","column","filter","d","callback","search","keys","length","$","addClass","removeClass","set","query","get","skip","dataTable","api","page","draw","isObject","doExport","queryOptions","querySelector","selector","export","field","schema","simpleSchema","label","findWhere","titleFn","title","fileName","id","tableId","publication","extraFields","compositePublicationNames","$and","limit","sort","filterModalCallback","columnIndex","optionsOrQuery","operator","sortDirection","multiSort","redraw","forceChange","context","aoColumns","order","o","fieldName","filterModal","name","existing","find","col","changed","undefined","push","splice","c","indexOf","Tracker","nonreactive","startsWith","fullSearch","newAdvancedSearchField","$lte","$gte","isArray","$not","$all","$regex","RegExp","$options","searchOptions","arrayToReplaceIn","found","obj","arr","$or","matches","some","searchObj","oldObj","isEqual","sortBy","someOperator","includes","equals","toJSONValue","searchResult","modifyFilterCallback","loading","setup","self","currentData","Template","subManager","sub","_connection","Meteor","forEach","tmpl","editTmpl","defaultContent","templateName","viewName","createdCell","td","value","rowData","row","rawRowData","rawContent","innerHTML","tmplContext","editRowData","doc","enableEdit","blaze","idOrData","parentElement","replaceChild","cell","dataVar","editable","split","templateData","editTemplateName","editTemplateData","editTmplContext","ret","Blaze","renderWithData","dynamicTableTableCell","view","render","type","caseInsensitive","regex","ajaxOptions","pageOptions","start","index","sortField","dir","ajaxSelector","join","isFunction","union","userId","searchable","getOptions","unique","pluck","fieldsObject","object","times","subscriptionOptions","DynamicTable","onRendered","$tableElement","lastId","args","apply","autorun","call","tableSpec","serverSide","initComplete","advancedSearchButton","buttonHtml","html","css","append","onEnterOnly","replaceSearchLabel","newText","contents","nodeType","textContent","trim","replaceWith","unbind","bind","event","keyCode","headerCallback","headerRow","fnSettings","each","headerCell","titleTmpl","__blazeViewInstance","remove","titleTmplContext","dynamicTableHeaderCell","removeColumn","titleFunction","ajax","_selector","changeSelector","completeStart","Date","getTime","oldQuery","JSON","stringify","sorting","ajaxCallback","isReady","destroy","drawCallback","on","pageNumber","lengthChangeCallback","e","settings","len","pageChangeCallback","orderCallback","sortable","newSub","subToStop","stop","clear","loaded","useArrayPublication","subscribe","subscriptionId","tableInfo","findOne","_id","status","fetch","recordsFiltered","recordsTotal","_ids","slice","i","ready","handle","initializing","cursor","$in","omit","count","docs","observeChanges","_suppress_initial","addedBefore","movedBefore","rowsData","toArray","rowIndex","aoData","_aData","node","cellIndex","oldData","newData","invalidate","console","log","hasSortableFields","intersection","wrappedColReorder","onCreated","fn","dataTableExt","oApi","fnColReorder","oldFnColReorder","fromJSONValue","advancedFilter","incomingSelector","_columns","documentMouseDown","filterModalWrapper","has","target","__blazeTemplate","manageFieldsWrapper","document","addEventListener","oldColumns","comp","firstRun","missingColumn","nc","oc","idx","tdorh","children","anCells","afterFlush","dep","reload","forceRefresh","onDestroyed","removeEventListener","tableElement","dt","DataTable","events","instance","helpers"],"mappings":"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","sourcesContent":["import { ReactiveVar } from \"meteor/reactive-var\";\nimport { Modal } from \"meteor/peppelg:bootstrap-3-modal\";\nimport { EJSON } from \"meteor/ejson\";\nimport \"./table.html\";\nimport \"./table.css\";\nimport \"./exportModal.js\";\nimport \"./components/filterModal/filterModal.js\";\nimport \"./advancedSearchModal.js\";\nimport \"./components/headerCell/headerCell.js\";\nimport \"./components/rawRender/rawRender.js\";\nimport \"./components/tableCell/tableCell.js\";\nimport \"./components/singleValueTextEditor/singleValueTextEditor.js\";\nimport \"./components/select2ValueEditor/select2ValueEditor.js\";\nimport { getTableRecordsCollection } from \"../db.js\";\n\n/**\n  @this Template.instance()\n*/\nfunction doAdvancedSearch(extraOptions) {\n  const options = this.data.table;\n  const templateInstance = this;\n  Modal.show(\"dynamicTableAdvancedSearchModal\", _.extend({\n    beforeRender: options.advancedSearch.beforeRender,\n    collection: options.advancedSearch.collection || this.data.table.collection,\n    fields: options.advancedSearch.fields || _.compact(options.columns.map(column => column.data).filter(d => d !== \"_id\")),\n    columns: options.columns,\n    callback: options.advancedSearch.callback || ((search) => {\n      if (_.keys(search).length) {\n        templateInstance.$(\".advanced-search-button\").addClass(\"hasSearch\");\n      }\n      else {\n        templateInstance.$(\".advanced-search-button\").removeClass(\"hasSearch\");\n      }\n      templateInstance.advancedSearch.set(search);\n      const query = templateInstance.query.get();\n      query.options.skip = 0;\n      templateInstance.query.set(query);\n      templateInstance.dataTable.api().page(0).draw(false);\n    }),\n    search: this.advancedSearch.get()\n  }, _.isObject(extraOptions) ? extraOptions : {}));\n}\n\n/**\n  @this Template.instance()\n*/\nfunction doExport(extraOptions) {\n  const query = this.query.get();\n  const templateInstance = this;\n  const advancedSearch = this.advancedSearch.get();\n  if (!query) {\n    return;\n  }\n  const queryOptions = query.options;\n  const querySelector = query.selector;\n\n  const table = this.data.table;\n  if (!table.export.fields) {\n    table.export.fields = this.columns.filter(column => column.data && column.data !== \"_id\").map(column => ({\n      field: column.data\n    }));\n  }\n  const schema = table.collection.simpleSchema && table.collection.simpleSchema();\n  table.export.fields = table.export.fields.map((field) => {\n    if (!_.isObject(field)) {\n      field = { field };\n    }\n    if (!field.label) {\n      const column = _.findWhere(this.columns, { data: field.field });\n      if (column) {\n        field.label = column.titleFn ? column.titleFn() : column.title;\n      }\n      else if (schema) {\n        field.label = schema.label(field.field) || field.field;\n      }\n    }\n    return field;\n  });\n  if (!table.export.fileName) {\n    table.export.fileName = this.data.id;\n  }\n\n  Modal.show(\"dynamicTableExportModal\", _.extend({}, {\n    tableId: this.data.id,\n    export: table.export,\n    publication: table.publication,\n    extraFields: table.extraFields || [],\n    compositePublicationNames: table.compositePublicationNames,\n    collection: table.collection,\n    advancedSearch: {},\n    selector: _.keys(advancedSearch).length ? { $and: [querySelector, advancedSearch] } : querySelector,\n    skip: queryOptions.skip || 0,\n    limit: queryOptions.limit,\n    sort: queryOptions.sort,\n    columns: this.columns\n  }, _.isObject(extraOptions) ? extraOptions : {}));\n}\n\nfunction filterModalCallback(columnIndex, optionsOrQuery, operator, sortDirection, multiSort = false, redraw = true, forceChange = false) {\n  const columns = this.dataTable.api().context[0].aoColumns;\n  const order = this.dataTable.api().order().map(o => ({\n    id: columns[o[0]].id,\n    data: columns[o[0]].data,\n    order: o[1]\n  }));\n  let fieldName = columns[columnIndex].data;\n  if (columns[columnIndex].filterModal && columns[columnIndex].filterModal.field && columns[columnIndex].filterModal.field.name) {\n    fieldName = columns[columnIndex].filterModal.field.name;\n  }\n  const existing = _.find(order, col => (col.id && col.id === columns[columnIndex].id) || col.data === columns[columnIndex].data);\n  let changed = false;\n  if (sortDirection !== undefined) {\n    if (existing) {\n      changed = existing.order !== (sortDirection === 1 ? \"asc\" : \"desc\");\n      existing.order = sortDirection === 1 ? \"asc\" : \"desc\";\n    }\n    else if (multiSort) {\n      order.push({\n        id: columns[columnIndex].id,\n        data: columns[columnIndex].data,\n        order: sortDirection === 1 ? \"asc\" : \"desc\"\n      });\n      changed = true;\n    }\n    else {\n      order.splice(0, order.length, {\n        id: columns[columnIndex].id,\n        data: columns[columnIndex].data,\n        order: sortDirection === 1 ? \"asc\" : \"desc\"\n      });\n    }\n    this.dataTable.api().order(order.map((o) => {\n      const column = _.find(columns, c => (c.id && c.id === o.id) || c.data === o.data);\n      return [\n        columns.indexOf(column),\n        o.order\n      ];\n    }));\n  }\n\n  // NOTE: we only want to run this code when triggered, not by an advanced search change.\n  const advancedSearch = Tracker.nonreactive(() => this.advancedSearch.get());\n  const startsWith = !columns[columnIndex].fullSearch;\n\n  // NOTE: added .length to ensure correctness when disabling all options (e.g., add diagrams modal)\n  if (optionsOrQuery && optionsOrQuery.length) {\n    let newAdvancedSearchField;\n    if (operator === \"$between\") {\n      newAdvancedSearchField = {\n        $lte: optionsOrQuery[1],\n        $gte: optionsOrQuery[0]\n      };\n    }\n    else if (operator === \"$gte\" || operator === \"$lte\") {\n      newAdvancedSearchField = {\n        [operator]: optionsOrQuery\n      };\n    }\n    else if (_.isArray(optionsOrQuery) && optionsOrQuery.length) {\n      if (operator === \"$not$all\") {\n        newAdvancedSearchField = { $not: { $all: optionsOrQuery } };\n      }\n      else {\n        newAdvancedSearchField = { [operator]: optionsOrQuery };\n      }\n    }\n    else if (!_.isArray(optionsOrQuery) && optionsOrQuery !== \"\") {\n      newAdvancedSearchField = operator === \"$regex\" ? { $regex: `${startsWith ? \"^\" : \"\"}${optionsOrQuery}` } : { $not: new RegExp(`${startsWith ? \"^\" : \"\"}${optionsOrQuery}`) };\n    }\n    if (columns[columnIndex].search) {\n      newAdvancedSearchField = columns[columnIndex].search(_.extend({}, newAdvancedSearchField, { $options: columns[columnIndex].searchOptions }), false);\n      let arrayToReplaceIn = advancedSearch.$and || [];\n      let found = false;\n      arrayToReplaceIn = arrayToReplaceIn.map((obj) => {\n        const arr = obj.$or || obj.$and;\n        if (_.isArray(newAdvancedSearchField)) {\n          const matches = newAdvancedSearchField.some(searchObj => arr.find(oldObj => _.isEqual(_.sortBy(_.keys(searchObj)), _.sortBy(_.keys(oldObj)))));\n          if (matches) {\n            found = true;\n            return { [obj.$or ? \"$or\" : \"$and\"]: newAdvancedSearchField };\n          }\n        }\n        else {\n          const matches = _.isEqual(_.sortBy(_.keys(newAdvancedSearchField)), _.sortBy(_.keys(obj)));\n          if (matches) {\n            found = true;\n            return newAdvancedSearchField;\n          }\n        }\n        return obj;\n      });\n      if (!found) {\n        if (_.isArray(newAdvancedSearchField)) {\n          const someOperator = [\"$regex\", \"$in\"].includes(operator) ? \"$or\" : \"$and\";\n          arrayToReplaceIn.push({ [someOperator]: newAdvancedSearchField });\n        }\n        else {\n          arrayToReplaceIn.push(newAdvancedSearchField);\n        }\n      }\n      if (!EJSON.equals(EJSON.toJSONValue(arrayToReplaceIn), EJSON.toJSONValue(advancedSearch.$and))) {\n        advancedSearch.$and = arrayToReplaceIn;\n        this.advancedSearch.set(advancedSearch);\n        changed = true;\n      }\n    }\n    else if (!EJSON.equals(EJSON.toJSONValue(advancedSearch[fieldName]), EJSON.toJSONValue(newAdvancedSearchField))) {\n      if (newAdvancedSearchField) {\n        advancedSearch[fieldName] = _.extend({}, newAdvancedSearchField, { $options: columns[columnIndex].searchOptions });\n      }\n      this.advancedSearch.set(advancedSearch);\n      changed = true;\n    }\n  }\n  else if (fieldName && advancedSearch[fieldName]) {\n    delete advancedSearch[fieldName];\n    this.advancedSearch.set(advancedSearch);\n    changed = true;\n  }\n  else if (columns[columnIndex].search) {\n    const searchResult = columns[columnIndex].search({ $regex: \"\" });\n    let arrayToReplaceIn = advancedSearch.$and || [];\n    arrayToReplaceIn = arrayToReplaceIn.map((obj) => {\n      const arr = obj.$or || obj.$and;\n      if (_.isArray(searchResult)) {\n        const matches = searchResult.some(searchObj => arr.find(oldObj => _.isEqual(_.sortBy(_.keys(searchObj)), _.sortBy(_.keys(oldObj)))));\n        if (matches) {\n          return null;\n        }\n      }\n      else {\n        const matches = _.isEqual(_.sortBy(_.keys(searchResult)), _.sortBy(_.keys(obj)));\n        if (matches) {\n          return null;\n        }\n      }\n      return obj;\n    });\n    arrayToReplaceIn = _.compact(arrayToReplaceIn);\n    if (arrayToReplaceIn && arrayToReplaceIn.length) {\n      advancedSearch.$and = arrayToReplaceIn;\n    }\n    else {\n      delete advancedSearch.$and;\n    }\n    this.advancedSearch.set(advancedSearch);\n    changed = true;\n  }\n  if (changed || forceChange) {\n    if (this.data.modifyFilterCallback) {\n      this.data.modifyFilterCallback(advancedSearch, order, columns);\n    }\n    if (redraw) {\n      this.dataTable.loading.set(true);\n      this.dataTable.api().draw();\n    }\n  }\n}\n/**\n  @this Template.instance()\n*/\nfunction setup() {\n  const self = this;\n  const currentData = Tracker.nonreactive(() => Template.currentData());\n  self.query.set(null);\n  // NOTE: allow for subscription managers.\n  self.subManager = currentData.table.sub;\n  if (!self.subManager) {\n    self.subManager = currentData.table.collection._connection || Meteor;\n  }\n\n  // NOTE: ensure we have clean data.\n  currentData.table.extraFields = currentData.table.extraFields || [];\n  self.columns = (currentData.table.columns || []).map(c => _.extend({}, c));\n  self.columns.forEach((column) => {\n    if (column.tmpl || column.editTmpl) {\n      if (!column.defaultContent) {\n        column.defaultContent = \"\";\n      }\n      const templateName = (column.tmpl && column.tmpl.viewName) || \"Template.dynamicTableRawRender\";\n\n      column.createdCell = function createdCell(td, value, rowData, row, col) {\n        const rawRowData = rowData;\n        const rawContent = td.innerHTML !== undefined ? td.innerHTML : value;\n        td.innerHTML = \"\";\n        if (column.tmplContext && rowData) {\n          rowData = column.tmplContext(rowData, self.data);\n        }\n        const editRowData = {\n          doc: rawRowData,\n          column,\n          collection: currentData.table.collection\n        };\n        const enableEdit = column.enableEdit ? column.enableEdit(rawRowData) : true;\n        if (self.blaze[`${row}-${col}`]) {\n          if (self.blaze[`${row}-${col}`].name === templateName && self.blaze[`${row}-${col}`].idOrData === (column.id || column.data)) {\n            td.parentElement.replaceChild(self.blaze[`${row}-${col}`].cell, td);\n            self.blaze[`${row}-${col}`].tmpl.dataVar.set({\n              editable: !!column.editTmpl && enableEdit,\n              templateName: templateName.split(\".\")[1],\n              templateData: column.tmpl ? rowData : rawContent,\n              editTemplateName: column.editTmpl && column.editTmpl.viewName.split(\".\")[1],\n              editTemplateData: column.editTmplContext ? column.editTmplContext(editRowData) : editRowData\n            });\n            return self.blaze[`${row}-${col}`].tmpl;\n          }\n          delete self.blaze[`${row}-${col}`];\n        }\n        const ret = Blaze.renderWithData(Template.dynamicTableTableCell, {\n          editable: !!column.editTmpl && enableEdit,\n          templateName: templateName.split(\".\")[1],\n          templateData: column.tmpl ? rowData : rawContent,\n          editTemplateName: column.editTmpl && column.editTmpl.viewName.split(\".\")[1],\n          editTemplateData: column.editTmplContext ? column.editTmplContext(editRowData) : editRowData\n        }, td, self.view);\n        self.blaze[`${row}-${col}`] = {\n          idOrData: column.id || column.data,\n          name: templateName,\n          cell: td,\n          tmpl: ret\n        };\n        return ret;\n      };\n\n      if (!column.render && column.data) {\n        column.render = function render(data, type) {\n          // NOTE: changing this causes problems above with rawContent, why it needs to be \"\" (versus the value or undefined) is anyones guess.\n          return data; // type === \"display\" ? \"\" : data;\n        };\n      }\n    }\n\n    if (!column.defaultContent) {\n      column.defaultContent = column.defaultContent || \"\";\n    }\n  });\n  if (currentData.table.search === undefined) {\n    currentData.table.search = {\n      caseInsensitive: true,\n      regex: true\n    };\n  }\n  else {\n    if (currentData.table.search.caseInsensitive === undefined) {\n      currentData.table.search.caseInsensitive = true;\n    }\n    if (currentData.table.search.regex === undefined) {\n      currentData.table.search.regex = true;\n    }\n  }\n}\n\n/**\n  @param data Object - the first argument to the ajax call\n  @param options Object - the global options of the data subscription\n  @param currentData Object - the arguments passed into the template.\n*/\nfunction ajaxOptions(data, options, columns) {\n  const pageOptions = {\n    skip: data.start\n  };\n  if (data.length && data.length !== -1) {\n    pageOptions.limit = data.length;\n  }\n  if (data.order) {\n    pageOptions.sort = {};\n    data.order.forEach((order, index) => {\n      if (columns[order.column] && (columns[order.column].data || columns[order.column].sortField)) {\n        if (columns[order.column].sortField) {\n          pageOptions.sort[columns[order.column].sortField] = 1 * (order.dir === \"desc\" ? -1 : 1);\n        }\n        else {\n          pageOptions.sort[columns[order.column].data] = 1 * (order.dir === \"desc\" ? -1 : 1);\n        }\n      }\n    });\n  }\n\n  return _.extend({}, options, pageOptions);\n}\n\n/**\n  @param data Object - the first argument to the ajax call\n  @param selector Object - the selector for the raw query (no search)\n  @param currentData Object - the arguments passed into the template.\n*/\nfunction ajaxSelector(data, selector, columns, caseInsensitive) {\n  const querySelector = _.extend({}, selector);\n  if (data.search && data.search.value !== \"\") {\n    querySelector.$or = [];\n    const search = (data.search.regex || caseInsensitive) ? {\n      $regex: data.search.value.split(\"\\\\\").join(\"\\\\\\\\\")\n    } : data.search.value;\n\n    if (caseInsensitive) {\n      search.$options = \"i\";\n    }\n\n    columns.forEach((column) => {\n      if (_.isFunction(column.search)) {\n        querySelector.$or = _.union(querySelector.$or, column.search(search, Meteor.userId()));\n      }\n      else if (column.data && column.searchable !== false) {\n        querySelector.$or.push({ [column.data]: search });\n      }\n    });\n  }\n  return querySelector;\n}\n\nfunction getOptions(currentData, columns) {\n  // NOTE: we want all fields defined in columns + all extraFields\n  let fields = _.union(_.unique(_.compact(_.pluck(columns, \"data\"))), currentData.table.extraFields);\n  fields = fields.filter(field => field.includes && (!field.includes(\".\") || !fields.includes(field.split(\".\")[0])));\n  const fieldsObject = _.object(fields, _.times(fields.length, () => true));\n  const options = _.extend({ fields: fieldsObject }, currentData.table.subscriptionOptions || {});\n\n  // NOTE: if we have a hard limit (e.g., no paging specified)\n  if (currentData.table.limit) {\n    options.limit = currentData.table.limit;\n  }\n  return options;\n}\nTemplate.DynamicTable.onRendered(function onRendered() {\n  const self = this;\n  const templateInstance = this;\n  this.$tableElement = $(this.$(\"table\")[0]);\n  let lastId;\n  if (this.data.table.export) {\n    this.$tableElement.data(\"do-export\", (...args) => {\n      doExport.apply(templateInstance, args);\n    });\n  }\n\n  if (this.data.table.advancedSearch) {\n    this.$tableElement.data(\"do-advancedSearch\", (...args) => {\n      doAdvancedSearch.apply(templateInstance, args);\n    });\n  }\n  this.autorun(() => {\n    templateInstance.tableId.get();\n    const currentData = Tracker.nonreactive(() => Template.currentData());// NOTE: intentionally not reactive.\n    setup.call(self);\n    const options = getOptions(currentData, self.columns);\n\n    // TODO: left in for compatibility - to be removed.\n    const tableSpec = _.extend({\n      serverSide: true,\n      initComplete() {\n        const table = templateInstance.data.table;\n        if (table.advancedSearch) {\n          const advancedSearchButton = currentData.table.advancedSearch.buttonHtml ? $(currentData.table.advancedSearch.buttonHtml) : $(\"<buton>\").addClass(\"advanced-search-button\")\n          .addClass(\"btn btn-default\")\n          .html(\"<i class='fa fa-search'></i>\")\n          .css(\"margin-top\", \"-10px\");\n          templateInstance.$(\".dataTables_filter>label\").append(advancedSearchButton);\n        }\n        if (table.search && table.search.onEnterOnly) {\n          const replaceSearchLabel = (newText) => {\n            $(\".dataTables_filter label\").contents().filter(function filter() {\n              return this.nodeType === 3 && this.textContent.trim().length;\n            }).replaceWith(newText);\n          };\n          $(\".dataTables_filter input\")\n          .unbind()\n          .bind(\"keyup change\", (event) => {\n            if (!templateInstance.dataTable) return;\n            if (event.keyCode === 13 || this.value === \"\") {\n              replaceSearchLabel(\"Search:\");\n              templateInstance.dataTable.search(this.value).draw();\n            }\n            else {\n              replaceSearchLabel(\"Search (hit enter):\");\n            }\n          });\n        }\n      },\n      headerCallback(headerRow) {\n        const columns = self.dataTable.fnSettings().aoColumns;\n\n        $(headerRow).find(\"td,th\").each((index, headerCell) => {\n          if (columns[index].titleTmpl) {\n            if (headerCell.__blazeViewInstance) {\n              Blaze.remove(headerCell.__blazeViewInstance);\n            }\n            headerCell.innerHTML = \"\";\n            headerCell.__blazeViewInstance = Blaze.renderWithData(\n              columns[index].titleTmpl,\n              columns[index].titleTmplContext ? columns[index].titleTmplContext(templateInstance.data) : {},\n              headerCell\n            );\n          }\n          else if (columns[index].filterModal) {\n            if (headerCell.__blazeViewInstance) {\n              Blaze.remove(headerCell.__blazeViewInstance);\n            }\n            headerCell.innerHTML = \"\";\n            headerCell.__blazeViewInstance = Blaze.renderWithData(\n              Template.dynamicTableHeaderCell,\n              {\n                column: columns[index],\n                columnIndex: index,\n                table: currentData.table,\n                dataTable: templateInstance.dataTable,\n                advancedSearch: templateInstance.advancedSearch.get(),\n                filterModalCallback: filterModalCallback.bind(self),\n                removeColumn: templateInstance.data.removeColumn\n              },\n              headerCell\n            );\n          }\n          else {\n            const titleFunction = columns[index] && columns[index].titleFn;\n            if (typeof titleFunction === \"function\") {\n              headerCell.innerHTML = titleFunction();\n            }\n          }\n        });\n      },\n      ajax(data, callback) {\n        const _selector = Tracker.nonreactive(() => templateInstance.selector.get());\n        const selector = currentData.table.changeSelector ? currentData.table.changeSelector(_selector || {}) : (_selector || {});\n\n        templateInstance.completeStart = new Date().getTime();\n        const columns = self.dataTable && self.dataTable.api().context && self.dataTable.api().context[0] ? self.dataTable.api().context[0].aoColumns : self.columns;\n        const options = getOptions(currentData, columns);\n        // NOTE: the \"ajax\" call triggers a subscription rerun, iff queryOptions or querySelector has changed\n        const queryOptions = ajaxOptions(data, options, columns);\n        const querySelector = ajaxSelector(data, selector, columns, currentData.table.search.caseInsensitive);\n        const query = {\n          options: queryOptions,\n          selector: querySelector\n        };\n        const oldQuery = Tracker.nonreactive(() => self.query.get());\n        if (oldQuery && JSON.stringify(oldQuery && oldQuery.options && oldQuery.options.sort) !== JSON.stringify(queryOptions.sort)) {\n          templateInstance.sorting = true;\n        }\n        if (JSON.stringify(Tracker.nonreactive(() => self.query.get())) !== JSON.stringify(query)) {\n          self.query.set(query);\n          templateInstance.ajaxCallback = callback;\n        }\n      }\n    }, currentData.table, { columns: templateInstance.columns });\n    if (templateInstance.dataTable) {\n      templateInstance.dataTable.isReady = false;\n      templateInstance.dataTable.api().destroy();\n      if (currentData.id !== lastId) {\n        templateInstance.$(`#${currentData.id}`).html(\"\");\n      }\n      else {\n        templateInstance.$(`#${currentData.id}`).find(\"thead\").html(\"\");\n      }\n    }\n    lastId = currentData.id;\n    tableSpec.drawCallback = () => {\n      templateInstance.dataTable.loading.set(false);\n    };\n    templateInstance.dataTable = templateInstance.$(`#${currentData.id}`).dataTable(tableSpec);\n\n    templateInstance.$(`#${currentData.id}`).on(\"init.dt\", () => {\n      if (currentData.table.pageNumber) {\n        templateInstance.dataTable.api().page(currentData.table.pageNumber).draw(false);\n      }\n      templateInstance.dataTable.isReady = true;\n    });\n    if (tableSpec.lengthChangeCallback) {\n      templateInstance.$(`#${currentData.id}`).on(\"length.dt\", (e, settings, len) => {\n        if (!templateInstance.dataTable.isReady) {\n          return;\n        }\n        tableSpec.lengthChangeCallback(templateInstance.dataTable, len);\n      });\n    }\n    if (tableSpec.pageChangeCallback) {\n      templateInstance.$(`#${currentData.id}`).on(\"page.dt\", () => {\n        if (!templateInstance.dataTable.isReady) {\n          return;\n        }\n        tableSpec.pageChangeCallback(templateInstance.dataTable, templateInstance.dataTable.api().page());\n      });\n    }\n    if (tableSpec.orderCallback) {\n      templateInstance.$(`#${currentData.id}`).on(\"order.dt\", () => {\n        if (!templateInstance.dataTable.isReady) {\n          return;\n        }\n        if (tableSpec.orderCallback) {\n          tableSpec.orderCallback(templateInstance.dataTable, templateInstance.dataTable.api().order());\n        }\n      });\n    }\n    if (tableSpec.sortable) {\n      templateInstance.$(`#${currentData.id}>tbody`).sortable(tableSpec.sortable);\n    }\n    templateInstance.dataTable.loading = new ReactiveVar(true);\n  });\n\n  // NOTE: initialize the subscription according to the query options/selector\n  this.autorun(() => {\n    const currentData = templateInstance.data;\n    const query = templateInstance.query.get();\n    if (!query) {\n      return;\n    }\n    const queryOptions = query.options;\n    const querySelector = query.selector;\n    const advancedSearch = templateInstance.advancedSearch.get();\n\n\n    // NOTE: we dont want to rerun this since we're setting it just below\n    let newSub;\n    const subToStop = Tracker.nonreactive(() => {\n      if (templateInstance.sub.get()) {\n        if (templateInstance.sub.get().stop) {\n          return templateInstance.sub.get();\n        }\n        self.subManager.clear();\n      }\n    });\n    if (!currentData.table.publication) {\n      templateInstance.loaded.set(true);\n      return;\n    }\n    if (\n      currentData.table.useArrayPublication\n      || (currentData.table.useArrayPublication === undefined && (!currentData.table.compositePublicationNames || currentData.table.compositePublicationNames.length === 0))\n    ) {\n      templateInstance.loaded.set(false);\n      newSub = self.subManager.subscribe(\n        \"__dynamicTableResultsArray\",\n        currentData.id,\n        currentData.table.publication,\n        _.keys(advancedSearch).length ? { $and: [querySelector, advancedSearch] } : querySelector,\n        queryOptions\n      );\n      templateInstance.sub.set(newSub);\n    }\n    else {\n      templateInstance.loaded.set(false);\n      newSub = self.subManager.subscribe(\n        \"__dynamicTableResults\",\n        currentData.id,\n        currentData.table.publication,\n        currentData.table.compositePublicationNames,\n        _.keys(advancedSearch).length ? { $and: [querySelector, advancedSearch] } : querySelector,\n        queryOptions\n      );\n      templateInstance.sub.set(newSub);\n    }\n    if (subToStop && subToStop !== newSub && subToStop.subscriptionId !== newSub.subscriptionId) {\n      subToStop.stop();\n    }\n  });\n\n  // NOTE: wait for the subscription and then fetch and observe the data.\n  this.autorun(() => {\n    const ajaxCallback = templateInstance.ajaxCallback;\n    templateInstance.tableId.get();\n    const currentData = templateInstance.data;\n    const query = templateInstance.query.get();\n    if (!query) {\n      return;\n    }\n    const queryOptions = query.options;\n    let tableInfo = getTableRecordsCollection(currentData.table.collection._connection).findOne({ _id: currentData.id });\n    if (!tableInfo && (Meteor.status().status === \"offline\" || !currentData.table.publication)) {\n      const advancedSearch = templateInstance.advancedSearch.get();\n      const options = _.extend({}, query.options);\n      delete options.limit;\n      delete options.skip;\n      options.fields = { _id: true };\n      const data = currentData.table.collection.find(_.keys(advancedSearch).length ? { $and: [query.selector, advancedSearch] } : query.selector, options).fetch();\n\n      tableInfo = {\n        recordsFiltered: data.length,\n        recordsTotal: data.length,\n        _ids: data.slice(queryOptions.skip || 0, (queryOptions.skip || 0) + (queryOptions.limit || 10000000)).map(i => i._id)\n      };\n    }\n    if ((!currentData.table.publication || (templateInstance.sub.get() && templateInstance.sub.get().ready())) && tableInfo) {\n      templateInstance.loaded.set(true);\n      if (templateInstance.handle) {\n        templateInstance.handle.stop();\n      }\n      let initializing = true;\n      // NOTE: tableInfo._ids already contains the ids of the documents to find - so no skip\n      const cursor = Tracker.nonreactive(() => currentData.table.collection.find({ _id: { $in: tableInfo._ids } }, _.omit(queryOptions, \"skip\")));\n      const count = cursor.count(); // MUST BE REACTIVE to track document removals and additions in the case that we hit this line before all data is really added.\n      let docs = Tracker.nonreactive(() => cursor.fetch());\n      if (!this.sorting && currentData.table.sort) {\n        docs = _.sortBy(docs, currentData.table.sort);\n      }\n      templateInstance.handle = cursor.observeChanges({\n        _suppress_initial: true,\n        // NOTE: the entire autorun block reruns when data is added/removed\n        addedBefore() {},\n\n        // NOTE:\n        //      the entire autorun block reruns when data is moved in the sorted list\n        //      (because tableInfo returns a new sortd list)\n        //      a big optimization would be to not re-render the entire table on this\n        //      just the rows that have changed, which could be the entire table :(\n        movedBefore() {},\n\n        // NOTE: when a document is changed, right now just re-render the entire row\n        //       a future optimization would be to just re-render the cell that has changed.\n        changed(_id) {\n          if (!initializing) {\n            // NOTE: we can't rely on tableInfo._ids being in order as we might run the sort locally.\n            // const rowIndex = tableInfo._ids.indexOf(_id);\n\n            const rowsData = _.toArray(templateInstance.dataTable.api().data());\n            const rowIndex = rowsData.indexOf(_.findWhere(rowsData, { _id }));\n\n            const rowData = currentData.table.collection.findOne({ _id });\n            const columns = templateInstance.dataTable.fnSettings().aoColumns;\n            try {\n              const row = templateInstance.dataTable.api().row(rowIndex);\n              row.context[0].aoData[row[0]]._aData = rowData;\n              $(templateInstance.dataTable.api().row(rowIndex).node()).find(\"td,th\").each((cellIndex) => {\n                const column = columns[cellIndex];\n                if (column.tmpl || column.editTmpl) {\n                  let changed = false;\n                  const templateName = (columns[cellIndex].tmpl && columns[cellIndex].tmpl.viewName) || \"Template.dynamicTableRawRender\";\n                  if (\n                    templateInstance.blaze[`${rowIndex}-${cellIndex}`].tmpl\n                    && templateInstance.blaze[`${rowIndex}-${cellIndex}`].name === templateName\n                    && templateInstance.blaze[`${rowIndex}-${cellIndex}`].idOrData === (columns[cellIndex].id || columns[cellIndex].data)\n                  ) {\n                    const oldData = templateInstance.blaze[`${rowIndex}-${cellIndex}`].tmpl.dataVar.get();\n                    if (columns[cellIndex].tmpl) {\n                      const newData = columns[cellIndex].tmplContext ? columns[cellIndex].tmplContext(rowData, templateInstance.data) : rowData;\n                      try {\n                        if (JSON.stringify(oldData.templateData) !== JSON.stringify(newData)) {\n                          oldData.templateData = newData;\n                          changed = true;\n                        }\n                      }\n                      catch (e) {\n                        oldData.templateData = newData;\n                        changed = true;\n                      }\n                    }\n                    else {\n                      const newData = templateInstance.dataTable.api().cell(rowIndex, cellIndex).render(\"data\");\n                      try {\n                        if (JSON.stringify(oldData.templateData) !== JSON.stringify(newData)) {\n                          oldData.templateData = newData;\n                          changed = true;\n                        }\n                      }\n                      catch (e) {\n                        oldData.templateData = newData;\n                        changed = true;\n                      }\n                    }\n                    const editRowData = {\n                      doc: rowData,\n                      column: templateInstance.columns[cellIndex],\n                      collection: templateInstance.data.table.collection\n                    };\n                    const newData = templateInstance.columns[cellIndex].editTmplContext ? templateInstance.columns[cellIndex].editTmplContext(editRowData) : editRowData;\n                    oldData.editTemplateData = newData;\n                    if (changed) {\n                      templateInstance.blaze[`${rowIndex}-${cellIndex}`].tmpl.dataVar.set(oldData);\n                    }\n                  }\n                }\n                else {\n                  templateInstance.dataTable.api().cell(rowIndex, cellIndex).invalidate();\n                }\n              });\n            }\n            catch (e) {\n              console.log(e);\n            }\n          }\n        }\n      });\n      initializing = false;\n      if (count < tableInfo._ids.length) {\n        return;\n      }\n\n      // NOTE: if we have all the fields we need to sort on, we dont need to use the non-oplog observe call on the server, but we have to sort client side.\n      const hasSortableFields = (!this.sorting && currentData.table.sort) || _.keys(queryOptions.fields || {}).length === 0 || _.intersection(_.keys(queryOptions.fields || {}), _.keys(queryOptions.sort || {})).length === _.keys(queryOptions.sort || {}).length;\n      ajaxCallback({\n        data: hasSortableFields ? docs : _.sortBy(docs, row => tableInfo._ids.indexOf(row._id)),\n        recordsFiltered: tableInfo.recordsFiltered,\n        recordsTotal: tableInfo.recordsTotal\n      });\n      if (this.sorting && currentData.table.sortable) {\n        currentData.table.sortable.stop();\n      }\n      this.sorting = false;\n    }\n  });\n});\n\nlet wrappedColReorder = false;\nTemplate.DynamicTable.onCreated(function onCreated() {\n  const self = this;\n\n  if (!wrappedColReorder && $.fn.dataTableExt.oApi.fnColReorder) {\n    wrappedColReorder = true;\n    const oldFnColReorder = $.fn.dataTableExt.oApi.fnColReorder;\n    $.fn.dataTableExt.oApi.fnColReorder = function fnColReorder(...args) {\n      while (args.length < 5) {\n        args.push(undefined);\n      }\n      if (args[args.length - 1] === undefined) {\n        args[args.length - 1] = false;\n      }\n      oldFnColReorder.apply(this, args);\n    };\n  }\n  this.loaded = new ReactiveVar(true);\n  this.sub = new ReactiveVar(null);\n  this.selector = new ReactiveVar({});\n  this.options = new ReactiveVar({});\n  this.query = new ReactiveVar(false);\n  this.advancedSearch = new ReactiveVar(EJSON.fromJSONValue(this.data.advancedFilter || {}));\n  this.incomingSelector = new ReactiveVar({});\n  this.tableId = new ReactiveVar(\"\");\n  this._columns = new ReactiveVar([]);\n\n  this.documentMouseDown = (e) => {\n    const filterModalWrapper = $(\"#dynamic-table-filter-modal\")[0];\n    if (filterModalWrapper) {\n      if ($(filterModalWrapper).has(e.target).length) {\n        return;\n      }\n      Blaze.remove(filterModalWrapper.__blazeTemplate);\n      filterModalWrapper.innerHTML = \"\";\n    }\n    const manageFieldsWrapper = $(\"#dynamic-table-manage-fields-modal\")[0];\n    if (manageFieldsWrapper) {\n      if ($(manageFieldsWrapper).has(e.target).length) {\n        return;\n      }\n      Blaze.remove(manageFieldsWrapper.__blazeTemplate);\n      manageFieldsWrapper.innerHTML = \"\";\n    }\n  };\n\n  document.addEventListener(\"mousedown\", this.documentMouseDown);\n  let oldColumns;\n  this.autorun((comp) => {\n    const columns = this._columns.get();\n    if (comp.firstRun) {\n      oldColumns = this.data.table.columns;\n      return;\n    }\n    if (columns.length < oldColumns.length) {\n      const context = this.dataTable.api().context[0];\n      const missingColumn = context.aoColumns.find(nc => !_.find(columns, oc => (oc._id ? oc._id === nc._id : oc.data === nc.data)));\n      let index = missingColumn.idx;\n      const tdorh = this.$(\"thead\").find(`td[data-column-index=${index}],th[data-column-index=${index}]`)[0];\n      if (tdorh) { // NOTE: data-column-index is only added when colReorder is used\n        index = _.toArray(this.$(\"thead>tr\")[0].children).indexOf(tdorh);\n      }\n      this.$(\"thead\").find(`td:nth-child(${index + 1}),th:nth-child(${index + 1})`).remove();\n      this.$(\"tbody>tr\").find(`td:nth-child(${index + 1}),th:nth-child(${index + 1})`).remove();\n      this.dataTable.api().context[0].aoColumns.splice(index, 1);\n      this.dataTable.api().context[0].aoData[0].anCells.splice(index, 1);\n      this.blaze = {};\n    }\n    else {\n      Tracker.afterFlush(() => {\n        this.tableId.dep.changed();\n        if (self.dataTable) {\n          self.dataTable.api().ajax.reload();\n        }\n      });\n    }\n    oldColumns = columns;\n  });\n  let forceRefresh;\n  this.autorun(() => {\n    const currentData = Template.currentData();\n    if (forceRefresh && forceRefresh !== currentData.forceRefresh) {\n      this.tableId.dep.changed();\n    }\n    forceRefresh = currentData.forceRefresh;\n  });\n  this.autorun(() => {\n    const currentData = Template.currentData();\n    if (Tracker.nonreactive(() => self.tableId.get()) !== currentData.id) {\n      oldColumns = currentData.table.columns.slice(0);\n      self.tableId.set(currentData.id);\n      oldColumns = currentData.table.columns.slice(0);\n    }\n    else if (Tracker.nonreactive(() => self._columns.get().length) !== currentData.table.columns.length) {\n      if (!oldColumns) {\n        oldColumns = currentData.table.columns;\n      }\n      self._columns.set(currentData.table.columns.slice(0));\n    }\n    if (JSON.stringify(Tracker.nonreactive(() => self.selector.get())) !== JSON.stringify(currentData.selector)) {\n      self.selector.set(currentData.selector);\n      if (self.dataTable) {\n        self.dataTable.api().ajax.reload();\n      }\n    }\n  });\n  this.blaze = {};\n});\n\n// NOTE: cleanup\n//       stop the subscription\n//       stop the observer\n//       destroy the data table and empty the actual table element\nTemplate.DynamicTable.onDestroyed(function onDestroyed() {\n  document.removeEventListener(\"mousedown\", this.documentMouseDown);\n  if (this.sub.get()) {\n    if (this.sub.get().stop) {\n      this.sub.get().stop();\n    }\n    else {\n      this.subManager.clear();\n    }\n  }\n  if (this.handle) {\n    this.handle.stop();\n  }\n  if (this.tableElement && this.$tableElement.length) {\n    const dt = this.$tableElement.DataTable();\n    if (dt) {\n      dt.destroy();\n    }\n    // this.$tableElement.html(\"\");\n  }\n});\n\nTemplate.DynamicTable.events({\n  \"click .advanced-search-button\"() {\n    doAdvancedSearch.call(Template.instance());\n  }\n});\n\nTemplate.DynamicTable.helpers({\n  loaded() {\n    return Template.instance().loaded.get();\n  }\n});\n"]},"sourceType":"script","hash":"e686ad0512deab6d4ed37ae3530a27d45cce78f8"}
