{"source":"__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nvar getUserQuerySelector, passwordValidator, userValidator;\n\nthis.Auth || (this.Auth = {});\n\n\n/*\n  A valid user will have exactly one of the following identification fields: id, username, or email\n */\n\nuserValidator = Match.Where(function(user) {\n  check(user, {\n    id: Match.Optional(String),\n    username: Match.Optional(String),\n    email: Match.Optional(String)\n  });\n  if (_.keys(user).length === !1) {\n    throw new Match.Error('User must have exactly one identifier field');\n  }\n  return true;\n});\n\n\n/*\n  A password can be either in plain text or hashed\n */\n\npasswordValidator = Match.OneOf(String, {\n  digest: String,\n  algorithm: String\n});\n\n\n/*\n  Return a MongoDB query selector for finding the given user\n */\n\ngetUserQuerySelector = function(user) {\n  if (user.id) {\n    return {\n      '_id': user.id\n    };\n  } else if (user.username) {\n    return {\n      'username': user.username\n    };\n  } else if (user.email) {\n    return {\n      'emails.address': user.email\n    };\n  }\n  throw new Error('Cannot create selector from invalid user');\n};\n\n\n/*\n  Log a user in with their password\n */\n\nthis.Auth.loginWithPassword = function(user, password) {\n  var authToken, authenticatingUser, authenticatingUserSelector, hashedToken, passwordVerification, ref;\n  if (!user || !password) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  check(user, userValidator);\n  check(password, passwordValidator);\n  authenticatingUserSelector = getUserQuerySelector(user);\n  authenticatingUser = Meteor.users.findOne(authenticatingUserSelector);\n  if (!authenticatingUser) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  if (!((ref = authenticatingUser.services) != null ? ref.password : void 0)) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  passwordVerification = Accounts._checkPassword(authenticatingUser, password);\n  if (passwordVerification.error) {\n    throw new Meteor.Error(401, 'Unauthorized');\n  }\n  authToken = Accounts._generateStampedLoginToken();\n  hashedToken = Accounts._hashLoginToken(authToken.token);\n  Accounts._insertHashedLoginToken(authenticatingUser._id, {\n    hashedToken: hashedToken\n  });\n  return {\n    authToken: authToken.token,\n    userId: authenticatingUser._id\n  };\n};\n","sourceMap":{"version":3,"file":"/lib/auth.coffee.js","sourceRoot":"","sources":["/packages/nimble_restivus/lib/auth.coffee"],"names":[],"mappings":"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","sourcesContent":["@Auth or= {}\n\n###\n  A valid user will have exactly one of the following identification fields: id, username, or email\n###\nuserValidator = Match.Where (user) ->\n  check user,\n    id: Match.Optional String\n    username: Match.Optional String\n    email: Match.Optional String\n\n  if _.keys(user).length is not 1\n    throw new Match.Error 'User must have exactly one identifier field'\n\n  return true\n\n###\n  A password can be either in plain text or hashed\n###\npasswordValidator = Match.OneOf(String,\n  digest: String\n  algorithm: String)\n\n###\n  Return a MongoDB query selector for finding the given user\n###\ngetUserQuerySelector = (user) ->\n  if user.id\n    return {'_id': user.id}\n  else if user.username\n    return {'username': user.username}\n  else if user.email\n    return {'emails.address': user.email}\n\n  # We shouldn't be here if the user object was properly validated\n  throw new Error 'Cannot create selector from invalid user'\n\n###\n  Log a user in with their password\n###\n@Auth.loginWithPassword = (user, password) ->\n  if not user or not password\n    throw new Meteor.Error 401, 'Unauthorized'\n\n  # Validate the login input types\n  check user, userValidator\n  check password, passwordValidator\n\n  # Retrieve the user from the database\n  authenticatingUserSelector = getUserQuerySelector(user)\n  authenticatingUser = Meteor.users.findOne(authenticatingUserSelector)\n\n  if not authenticatingUser\n    throw new Meteor.Error 401, 'Unauthorized'\n  if not authenticatingUser.services?.password\n    throw new Meteor.Error 401, 'Unauthorized'\n\n  # Authenticate the user's password\n  passwordVerification = Accounts._checkPassword authenticatingUser, password\n  if passwordVerification.error\n    throw new Meteor.Error 401, 'Unauthorized'\n\n  # Add a new auth token to the user's account\n  authToken = Accounts._generateStampedLoginToken()\n  hashedToken = Accounts._hashLoginToken authToken.token\n  Accounts._insertHashedLoginToken authenticatingUser._id, {hashedToken}\n\n  return {authToken: authToken.token, userId: authenticatingUser._id}\n"]}}